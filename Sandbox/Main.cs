using System;
using System.Numerics;
using System.Collections.Generic;
using System.Windows.Forms;
using System.Text.RegularExpressions;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;
using SpiceSharp.Circuits;

namespace Sandbox
{
    public partial class Main : Form
    {
        /// <summary>
        /// Constructor
        /// </summary>
        public Main()
        {
            InitializeComponent();
            var plotInput = chMain.Series.Add("Input");
            plotInput.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastPoint;
            var plotOutput = chMain.Series.Add("Output");
            plotOutput.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastPoint;

            /*
             * Pulsed voltage source towards a resistive voltage divider between 0V and 5V
             * Output voltage is expected to behavior like the reference
             */
            // Build circuit
            Circuit ckt = new Circuit();
            ckt.Objects.Add(
                new Voltagesource("V1", "in", "0", new Pulse(0, 5, 1e-6, 10e-9, 10e-9, 1e-6, 2e-6)),
                new Voltagesource("Vsupply", "vdd", "0", 5.0),
                new Resistor("R1", "vdd", "out", 10.0e3),
                new Resistor("R2", "out", "0", 10.0e3),
                CreateDiode("D1", "in", "out", "1N914", "Is = 2.52e-9 Rs = 0.568 N = 1.752 Cjo = 4e-12 M = 0.4 tt = 20e-9"));

            // Create simulation
            Transient tran = new Transient("tran", 1e-9, 10e-6);

            // Create exports
            Func<State, double>[] exports = new Func<State, double>[1];
            tran.InitializeSimulationExport += (object sender, InitializationDataEventArgs args) =>
            {
                exports[0] = tran.CreateVoltageExport("out");
            };

            // Create references
            double[] reft = {  0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.001000000000000e-06, 1.003000000000000e-06, 1.007000000000000e-06, 1.010000000000000e-06, 1.010800000000000e-06, 1.012400000000000e-06, 1.015600000000000e-06, 1.022000000000000e-06, 1.031911433197018e-06, 1.048368508161046e-06, 1.069192540388961e-06, 1.095608578756403e-06, 1.130208646203053e-06, 1.184769271793149e-06, 1.276992072526315e-06, 1.461437673992648e-06, 1.661437673992648e-06, 1.861437673992648e-06, 2.010000000000000e-06, 2.011000000000000e-06, 2.013000000000000e-06, 2.017000000000000e-06, 2.020000000000000e-06, 2.020800000000000e-06, 2.022400000000000e-06, 2.025600000000000e-06, 2.032000000000000e-06, 2.044799999999999e-06, 2.061437072463280e-06, 2.078952434083369e-06, 2.098816346613151e-06, 2.127583585949885e-06, 2.183529765671426e-06, 2.295422125114509e-06, 2.495422125114509e-06, 2.695422125114509e-06, 2.895422125114509e-06, 3.000000000000000e-06, 3.001000000000000e-06, 3.003000000000000e-06, 3.007000000000000e-06, 3.010000000000000e-06, 3.010800000000000e-06, 3.012400000000000e-06, 3.015600000000000e-06, 3.022000000000000e-06, 3.031911420681667e-06, 3.048368420759695e-06, 3.069192453226679e-06, 3.095608446130901e-06, 3.130208468941833e-06, 3.184768907711479e-06, 3.276991420954321e-06, 3.461436447440003e-06, 3.661436447440003e-06, 3.861436447440003e-06, 4.010000000000000e-06, 4.010999999999999e-06, 4.013000000000000e-06, 4.017000000000000e-06, 4.020000000000000e-06, 4.020800000000000e-06, 4.022400000000000e-06, 4.025600000000000e-06, 4.032000000000000e-06, 4.044800000000000e-06, 4.061437072462956e-06, 4.078952434083383e-06, 4.098816346613415e-06, 4.127583585951825e-06, 4.183529765675620e-06, 4.295422125123208e-06, 4.495422125123208e-06, 4.695422125123207e-06, 4.895422125123207e-06, 5.000000000000000e-06, 5.000999999999999e-06, 5.002999999999999e-06, 5.007000000000000e-06, 5.009999999999999e-06, 5.010800000000000e-06, 5.012400000000000e-06, 5.015600000000000e-06, 5.022000000000000e-06, 5.031911420681666e-06, 5.048368420759693e-06, 5.069192453226679e-06, 5.095608446130897e-06, 5.130208468941830e-06, 5.184768907711480e-06, 5.276991420954274e-06, 5.461436447439861e-06, 5.661436447439861e-06, 5.861436447439861e-06, 6.009999999999999e-06, 6.010999999999999e-06, 6.012999999999999e-06, 6.016999999999999e-06, 6.019999999999999e-06, 6.020799999999999e-06, 6.022399999999999e-06, 6.025600000000000e-06, 6.031999999999999e-06, 6.044799999999999e-06, 6.061437072462956e-06, 6.078952434083383e-06, 6.098816346613413e-06, 6.127583585951822e-06, 6.183529765675614e-06, 6.295422125123198e-06, 6.495422125123198e-06, 6.695422125123198e-06, 6.895422125123197e-06, 6.999999999999999e-06, 7.001000000000000e-06, 7.003000000000000e-06, 7.007000000000000e-06, 7.010000000000000e-06, 7.010800000000000e-06, 7.012400000000000e-06, 7.015600000000000e-06, 7.022000000000001e-06, 7.031911420681667e-06, 7.048368420759696e-06, 7.069192453226681e-06, 7.095608446130902e-06, 7.130208468941837e-06, 7.184768907711489e-06, 7.276991420954271e-06, 7.461436447439835e-06, 7.661436447439836e-06, 7.861436447439836e-06, 8.010000000000000e-06, 8.011000000000000e-06, 8.012999999999999e-06, 8.017000000000000e-06, 8.019999999999999e-06, 8.020800000000000e-06, 8.022400000000000e-06, 8.025600000000000e-06, 8.032000000000000e-06, 8.044800000000000e-06, 8.061437072462955e-06, 8.078952434083383e-06, 8.098816346613414e-06, 8.127583585951824e-06, 8.183529765675615e-06, 8.295422125123197e-06, 8.495422125123197e-06, 8.695422125123197e-06, 8.895422125123197e-06, 9.000000000000000e-06, 9.001000000000001e-06, 9.003000000000000e-06, 9.007000000000000e-06, 9.010000000000000e-06, 9.010800000000000e-06, 9.012400000000000e-06, 9.015600000000001e-06, 9.022000000000001e-06, 9.031911420681667e-06, 9.048368420759694e-06, 9.069192453226679e-06, 9.095608446130898e-06, 9.130208468941829e-06, 9.184768907711475e-06, 9.276991420954306e-06, 9.461436447439965e-06, 9.661436447439964e-06, 9.861436447439964e-06, 9.999999999999999e-06 };
            double[] reference = { 2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600931e+00, 2.499987387600930e+00, 2.499987387600930e+00, 2.499987387600929e+00, 2.499987387600930e+00, 2.499987387600933e+00, 2.499987387600932e+00, 2.499987387600934e+00, 2.499987387600934e+00, 2.499987387600928e+00, 2.499987387600928e+00, 2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600926e+00, 2.499987387600928e+00, 2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600927e+00, 2.961897877874934e+00, 3.816739529558831e+00, 5.191526587205253e+00, 6.033962809915079e+00, 5.858560892037079e+00, 5.542221840643947e+00, 5.047948278928924e+00, 4.566221446174492e+00, 4.496222403679634e+00, 4.470638440255675e+00, 4.461747124949804e+00, 4.458828418109562e+00, 4.458043432344522e+00, 4.458104168570753e+00, 4.458101940017489e+00, 4.458103007267981e+00, 4.458102313327546e+00, 4.458102774372732e+00, 4.458102484881135e+00, 3.958696587137276e+00, 2.960963748330885e+00, 9.726613059613628e-01, -5.081214667849954e-01, -5.008294438061146e-01, -4.823457266305946e-01, -4.093596340082378e-01, 2.927533877100476e-01, 1.580990201373001e+00, 2.297731671229221e+00, 2.465955512323740e+00, 2.496576390164448e+00, 2.500278606332533e+00, 2.499872222320282e+00, 2.500061542030393e+00, 2.499929263366373e+00, 2.500032946810125e+00, 2.499951677124709e+00, 2.500009659840817e+00, 2.961918369398067e+00, 3.816756624765787e+00, 5.191537959402029e+00, 6.033971024560395e+00, 5.858568428923525e+00, 5.542228175717445e+00, 5.047952819852995e+00, 4.566222065264992e+00, 4.496222553506734e+00, 4.470638537994252e+00, 4.461747150642569e+00, 4.458828425715773e+00, 4.458043431871857e+00, 4.458104168387089e+00, 4.458101940091086e+00, 4.458103007220202e+00, 4.458102313359292e+00, 4.458102774351643e+00, 4.458102484892605e+00, 3.958696587148540e+00, 2.960963748341582e+00, 9.726613059724690e-01, -5.081214667705706e-01, -5.008294437900119e-01, -4.823457266089376e-01, -4.093596339411046e-01, 2.927533879025108e-01, 1.580990201486391e+00, 2.297731671249843e+00, 2.465955512329101e+00, 2.496576390165203e+00, 2.500278606332566e+00, 2.499872222320265e+00, 2.500061542030405e+00, 2.499929263366364e+00, 2.500032946810133e+00, 2.499951677124703e+00, 2.500009659840779e+00, 2.961918369398032e+00, 3.816756624765757e+00, 5.191537959401995e+00, 6.033971024560496e+00, 5.858568428923665e+00, 5.542228175717561e+00, 5.047952819853082e+00, 4.566222065265002e+00, 4.496222553506737e+00, 4.470638537994254e+00, 4.461747150642569e+00, 4.458828425715771e+00, 4.458043431871858e+00, 4.458104168387090e+00, 4.458101940091087e+00, 4.458103007220201e+00, 4.458102313359291e+00, 4.458102774351643e+00, 4.458102484892708e+00, 3.958696587148749e+00, 2.960963748341791e+00, 9.726613059726750e-01, -5.081214667704262e-01, -5.008294437900225e-01, -4.823457266089518e-01, -4.093596339411494e-01, 2.927533879023823e-01, 1.580990201486315e+00, 2.297731671249816e+00, 2.465955512329098e+00, 2.496576390165200e+00, 2.500278606332570e+00, 2.499872222320263e+00, 2.500061542030407e+00, 2.499929263366362e+00, 2.500032946810134e+00, 2.499951677124702e+00, 2.500009659840780e+00, 2.961918369398029e+00, 3.816756624765742e+00, 5.191537959401949e+00, 6.033971024560461e+00, 5.858568428923622e+00, 5.542228175717498e+00, 5.047952819852998e+00, 4.566222065264983e+00, 4.496222553506735e+00, 4.470638537994251e+00, 4.461747150642568e+00, 4.458828425715771e+00, 4.458043431871856e+00, 4.458104168387091e+00, 4.458101940091087e+00, 4.458103007220201e+00, 4.458102313359291e+00, 4.458102774351643e+00, 4.458102484892708e+00, 3.958696587148324e+00, 2.960963748341793e+00, 9.726613059726769e-01, -5.081214667704226e-01, -5.008294437900186e-01, -4.823457266089463e-01, -4.093596339411322e-01, 2.927533879024313e-01, 1.580990201486346e+00, 2.297731671249819e+00, 2.465955512329098e+00, 2.496576390165201e+00, 2.500278606332567e+00, 2.499872222320263e+00, 2.500061542030407e+00, 2.499929263366362e+00, 2.500032946810135e+00, 2.499951677124702e+00, 2.500009659840780e+00, 2.961918369398421e+00, 3.816756624765698e+00, 5.191537959401959e+00, 6.033971024560470e+00, 5.858568428923640e+00, 5.542228175717541e+00, 5.047952819853064e+00, 4.566222065265000e+00, 4.496222553506738e+00, 4.470638537994254e+00, 4.461747150642569e+00, 4.458828425715772e+00, 4.458043431871857e+00, 4.458104168387089e+00, 4.458101940091087e+00, 4.458103007220202e+00, 4.458102313359291e+00, 4.458102774351643e+00, 4.458102489285038e+00 };

            tran.OnExportSimulationData += (object sender, SimulationDataEventArgs args) =>
            {
                plotInput.Points.AddXY(args.GetTime(), exports[0](args.Circuit.State));
            };
            tran.Run(ckt);

            for (int i = 0; i < reft.Length; i++)
            {
                plotOutput.Points.AddXY(reft[i], reference[i]);
            }
        }

        /// <summary>
        /// Create a diode with a model
        /// </summary>
        /// <param name="name">Diode name</param>
        /// <param name="anode">Anode</param>
        /// <param name="cathode">Cathode</param>
        /// <param name="model">Model</param>
        /// <param name="modelparams">Model parameters</param>
        /// <returns></returns>
        protected static Diode CreateDiode(Identifier name, Identifier anode, Identifier cathode, Identifier model, string modelparams)
        {
            Diode d = new Diode(name);
            DiodeModel dm = new DiodeModel(model);
            ApplyParameters(dm, modelparams);
            d.SetModel(dm);
            d.Connect(anode, cathode);
            return d;
        }

        /// <summary>
        /// Apply a parameter definition to an entity
        /// Parameters are a series of assignments [name]=[value] delimited by spaces.
        /// </summary>
        /// <param name="entity">Entity</param>
        /// <param name="definition">Definition string</param>
        protected static void ApplyParameters(Entity entity, string definition)
        {
            // Get all assignments
            definition = Regex.Replace(definition, @"\s*\=\s*", "=");
            string[] assignments = definition.Split(new char[] { ',', ';', ' ' }, StringSplitOptions.RemoveEmptyEntries);
            foreach (var assignment in assignments)
            {
                // Get the name and value
                string[] parts = assignment.Split('=');
                if (parts.Length != 2)
                    throw new Exception("Invalid assignment");
                string name = parts[0].ToLower();
                double value = double.Parse(parts[1], System.Globalization.CultureInfo.InvariantCulture);

                // Set the entity parameter
                entity.Parameters.Set(name, value);
            }
        }
    }
}