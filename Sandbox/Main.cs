using System;
using System.Numerics;
using System.Collections.Generic;
using System.Windows.Forms;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;

namespace Sandbox
{
    public partial class Main : Form
    {
        public List<double> input = new List<double>();
        public List<double> output = new List<double>();

        /// <summary>
        /// Constructor
        /// </summary>
        public Main()
        {
            InitializeComponent();

            var plotOutput = chMain.Series.Add("Output");
            plotOutput.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastPoint;
            var plotReference = chMain.Series.Add("Reference");
            plotReference.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastPoint;
            plotReference.YAxisType = System.Windows.Forms.DataVisualization.Charting.AxisType.Secondary;

            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.001000000000000e-06, 1.003000000000000e-06, 1.007000000000000e-06, 1.010000000000000e-06, 1.010800000000000e-06, 1.012400000000000e-06, 1.015600000000000e-06, 1.022000000000000e-06, 1.031911430391792e-06, 1.048369261785013e-06, 1.069191308645388e-06, 1.095608292834102e-06, 1.130209722171300e-06, 1.184768886540801e-06, 1.276944878679060e-06, 1.461296862955580e-06, 1.661296862955580e-06, 1.861296862955580e-06, 2.010000000000000e-06, 2.011000000000000e-06, 2.013000000000000e-06, 2.017000000000000e-06, 2.020000000000000e-06, 2.020800000000000e-06, 2.022400000000000e-06, 2.025600000000000e-06, 2.032000000000000e-06, 2.044799999999999e-06, 2.061436842547180e-06, 2.078952305431347e-06, 2.098815989369024e-06, 2.127583095730346e-06, 2.183527668213025e-06, 2.295416813178385e-06, 2.495416813178385e-06, 2.695416813178385e-06, 2.895416813178384e-06, 3.000000000000000e-06, 3.001000000000000e-06, 3.003000000000000e-06, 3.007000000000000e-06, 3.010000000000000e-06, 3.010800000000000e-06, 3.012400000000000e-06, 3.015600000000000e-06, 3.022000000000000e-06, 3.031911417875101e-06, 3.048369174339688e-06, 3.069191221519299e-06, 3.095608160179535e-06, 3.130209544871514e-06, 3.184768522337625e-06, 3.276944226536039e-06, 3.461295634932866e-06, 3.661295634932866e-06, 3.861295634932866e-06, 4.010000000000000e-06, 4.010999999999999e-06, 4.013000000000000e-06, 4.017000000000000e-06, 4.020000000000000e-06, 4.020800000000000e-06, 4.022400000000000e-06, 4.025600000000000e-06, 4.032000000000000e-06, 4.044800000000000e-06, 4.061436842546919e-06, 4.078952305431358e-06, 4.098815989369235e-06, 4.127583095731905e-06, 4.183527668216395e-06, 4.295416813185373e-06, 4.495416813185372e-06, 4.695416813185372e-06, 4.895416813185372e-06, 5.000000000000000e-06, 5.000999999999999e-06, 5.002999999999999e-06, 5.007000000000000e-06, 5.009999999999999e-06, 5.010800000000000e-06, 5.012400000000000e-06, 5.015600000000000e-06, 5.022000000000000e-06, 5.031911417875101e-06, 5.048369174339686e-06, 5.069191221519295e-06, 5.095608160179533e-06, 5.130209544871505e-06, 5.184768522337617e-06, 5.276944226536067e-06, 5.461295634932967e-06, 5.661295634932967e-06, 5.861295634932966e-06, 6.009999999999999e-06, 6.010999999999999e-06, 6.012999999999999e-06, 6.016999999999999e-06, 6.019999999999999e-06, 6.020799999999999e-06, 6.022399999999999e-06, 6.025600000000000e-06, 6.031999999999999e-06, 6.044799999999999e-06, 6.061436842546919e-06, 6.078952305431357e-06, 6.098815989369235e-06, 6.127583095731905e-06, 6.183527668216393e-06, 6.295416813185368e-06, 6.495416813185368e-06, 6.695416813185367e-06, 6.895416813185367e-06, 6.999999999999999e-06, 7.001000000000000e-06, 7.003000000000000e-06, 7.007000000000000e-06, 7.010000000000000e-06, 7.010800000000000e-06, 7.012400000000000e-06, 7.015600000000000e-06, 7.022000000000001e-06, 7.031911417875102e-06, 7.048369174339689e-06, 7.069191221519296e-06, 7.095608160179537e-06, 7.130209544871513e-06, 7.184768522337624e-06, 7.276944226536064e-06, 7.461295634932944e-06, 7.661295634932945e-06, 7.861295634932945e-06, 8.010000000000000e-06, 8.011000000000000e-06, 8.012999999999999e-06, 8.017000000000000e-06, 8.019999999999999e-06, 8.020800000000000e-06, 8.022400000000000e-06, 8.025600000000000e-06, 8.032000000000000e-06, 8.044800000000000e-06, 8.061436842546919e-06, 8.078952305431358e-06, 8.098815989369237e-06, 8.127583095731908e-06, 8.183527668216399e-06, 8.295416813185379e-06, 8.495416813185379e-06, 8.695416813185379e-06, 8.895416813185379e-06, 9.000000000000000e-06, 9.001000000000001e-06, 9.003000000000000e-06, 9.007000000000000e-06, 9.010000000000000e-06, 9.010800000000000e-06, 9.012400000000000e-06, 9.015600000000001e-06, 9.022000000000001e-06, 9.031911417875101e-06, 9.048369174339687e-06, 9.069191221519297e-06, 9.095608160179534e-06, 9.130209544871508e-06, 9.184768522337627e-06, 9.276944226536070e-06, 9.461295634932955e-06, 9.661295634932954e-06, 9.861295634932954e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600928e+00, 2.499987387600930e+00, 2.499987387600930e+00, 2.499987387600930e+00, 2.499987387600929e+00, 2.499987387600930e+00, 2.499987387600929e+00, 2.499987387600931e+00, 2.499987387600932e+00, 2.499987387600930e+00, 2.499987387600925e+00, 2.499987387600928e+00, 2.499987387600926e+00, 2.499987387600928e+00, 2.499987387600926e+00, 2.499987387600927e+00, 2.499987387600927e+00, 2.499987387600928e+00, 2.499987387600927e+00, 2.961821123677441e+00, 3.815595031050632e+00, 5.191497375836692e+00, 6.033868333676702e+00, 5.858562191713297e+00, 5.542208256161848e+00, 5.047949608971144e+00, 4.566109930365761e+00, 4.496204694441634e+00, 4.470633619893430e+00, 4.461739126144179e+00, 4.458735839003547e+00, 4.458038898753162e+00, 4.458105659592958e+00, 4.458101331200549e+00, 4.458103397187390e+00, 4.458102054214761e+00, 4.458102946499696e+00, 4.458102386130604e+00, 3.958693411280502e+00, 2.960914649979985e+00, 9.726427700084964e-01, -5.082383499091155e-01, -5.008345064144687e-01, -4.824425124285373e-01, -4.093717899310994e-01, 2.924887048069172e-01, 1.580971980369440e+00, 2.297627508401225e+00, 2.465954137574416e+00, 2.496576060032440e+00, 2.500278626658742e+00, 2.499872214958067e+00, 2.500061543600388e+00, 2.499929261741765e+00, 2.500032947932400e+00, 2.499951676152186e+00, 2.500009660939910e+00, 2.961841609544899e+00, 3.815612080183933e+00, 5.191508748208870e+00, 6.033876548352698e+00, 5.858569729195014e+00, 5.542214591696127e+00, 5.047954150255141e+00, 4.566110570191042e+00, 4.496204841281153e+00, 4.470633717559513e+00, 4.461739151542467e+00, 4.458735845471297e+00, 4.458038898205160e+00, 4.458105659443782e+00, 4.458101331262269e+00, 4.458103397146694e+00, 4.458102054241805e+00, 4.458102946481730e+00, 4.458102386139813e+00, 3.958693411289590e+00, 2.960914649988631e+00, 9.726427700174073e-01, -5.082383498975664e-01, -5.008345064015178e-01, -4.824425124111943e-01, -4.093717898771109e-01, 2.924887049622513e-01, 1.580971980460653e+00, 2.297627508417691e+00, 2.465954137578724e+00, 2.496576060033046e+00, 2.500278626658768e+00, 2.499872214958052e+00, 2.500061543600398e+00, 2.499929261741757e+00, 2.500032947932406e+00, 2.499951676152183e+00, 2.500009660939873e+00, 2.961841609544864e+00, 3.815612080183901e+00, 5.191508748208831e+00, 6.033876548352796e+00, 5.858569729195150e+00, 5.542214591696239e+00, 5.047954150255220e+00, 4.566110570191053e+00, 4.496204841281158e+00, 4.470633717559518e+00, 4.461739151542469e+00, 4.458735845471298e+00, 4.458038898205158e+00, 4.458105659443782e+00, 4.458101331262271e+00, 4.458103397146695e+00, 4.458102054241805e+00, 4.458102946481730e+00, 4.458102386139918e+00, 3.958693411289800e+00, 2.960914649988843e+00, 9.726427700176185e-01, -5.082383498974148e-01, -5.008345064015201e-01, -4.824425124111975e-01, -4.093717898771213e-01, 2.924887049622209e-01, 1.580971980460636e+00, 2.297627508417681e+00, 2.465954137578724e+00, 2.496576060033047e+00, 2.500278626658769e+00, 2.499872214958052e+00, 2.500061543600398e+00, 2.499929261741757e+00, 2.500032947932406e+00, 2.499951676152183e+00, 2.500009660939873e+00, 2.961841609544861e+00, 3.815612080183887e+00, 5.191508748208779e+00, 6.033876548352758e+00, 5.858569729195099e+00, 5.542214591696174e+00, 5.047954150255137e+00, 4.566110570191032e+00, 4.496204841281155e+00, 4.470633717559513e+00, 4.461739151542469e+00, 4.458735845471298e+00, 4.458038898205160e+00, 4.458105659443782e+00, 4.458101331262270e+00, 4.458103397146695e+00, 4.458102054241805e+00, 4.458102946481730e+00, 4.458102386139918e+00, 3.958693411289377e+00, 2.960914649988845e+00, 9.726427700176202e-01, -5.082383498974127e-01, -5.008345064015177e-01, -4.824425124111943e-01, -4.093717898771107e-01, 2.924887049622511e-01, 1.580971980460655e+00, 2.297627508417698e+00, 2.465954137578724e+00, 2.496576060033045e+00, 2.500278626658769e+00, 2.499872214958053e+00, 2.500061543600398e+00, 2.499929261741757e+00, 2.500032947932406e+00, 2.499951676152183e+00, 2.500009660939873e+00, 2.961841609545255e+00, 3.815612080183843e+00, 5.191508748208792e+00, 6.033876548352767e+00, 5.858569729195123e+00, 5.542214591696219e+00, 5.047954150255206e+00, 4.566110570191052e+00, 4.496204841281157e+00, 4.470633717559517e+00, 4.461739151542467e+00, 4.458735845471296e+00, 4.458038898205158e+00, 4.458105659443781e+00, 4.458101331262271e+00, 4.458103397146695e+00, 4.458102054241805e+00, 4.458102946481729e+00, 4.458102394628059e+00
            };

            NetlistReader nr = new NetlistReader();
            nr.Netlist.Circuit.Nodes.Map("in");
            nr.Netlist.Circuit.Nodes.Map("vdd");
            nr.Netlist.Circuit.Nodes.Map("out");
            string netlist = string.Join(Environment.NewLine,
                ".model 1N914 D(Is = 2.52n Rs = .568 N = 1.752 Cjo = 4p M = .4 tt = 20n)",
                "D1 in out 1N914",
                "Vsupply vdd 0 5",
                "V1 in 0 PULSE(0 5 1u 10n 10n 1u 2u)",
                "R2 out 0 10k",
                "R1 vdd out 10k",
                ".SAVE v(out)",
                ".tran 1n 10u"
                );
            nr.Parse(new System.IO.MemoryStream(System.Text.Encoding.UTF8.GetBytes(netlist)));

            int index = 0;
            nr.Netlist.OnExportSimulationData += (object sender, SimulationData data) =>
            {
                plotOutput.Points.AddXY(data.GetTime(), data.GetVoltage("out"));

                /*
                if (index > 0)
                {
                    double delta = data.GetTime() - lasttime;
                    double refdelta = reft[index] - reft[index - 1];
                    plotReference.Points.AddXY(data.GetTime(), delta - refdelta);
                }
                index++;
                lasttime = data.GetTime(); */

                plotReference.Points.AddXY(reft[index], data.GetVoltage("out") - refv[index++]);
            };
            nr.Netlist.Simulate();

            chMain.ChartAreas[0].AxisX.Minimum = 0.95e-6;
            chMain.ChartAreas[0].AxisX.Maximum = 1.1e-6;
            chMain.ChartAreas[0].AxisX.RoundAxisValues();
        }
    }
}