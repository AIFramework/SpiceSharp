using System;
using System.IO;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Windows.Forms.DataVisualization.Charting;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;
using SpiceSharp.Parameters;
using SpiceSharp.Parser.Readers;
using SpiceSharp.Designer;
using SpiceSharp.Diagnostics;
using MathNet.Numerics.Interpolation;

namespace Sandbox
{
    public partial class Main : Form
    {
        private double[] timepoints = new double[]
        {
            0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000700000000000e-06, 1.001000000000000e-06, 1.001024537213360e-06, 1.001073611640081e-06, 1.001171760493522e-06, 1.001343674022283e-06, 1.001687501079805e-06, 1.002375155194848e-06, 1.003750463424934e-06, 1.006501079885107e-06, 1.012002312805452e-06, 1.022557889924683e-06, 1.043669044163145e-06, 1.075778006338748e-06, 1.118878446966086e-06, 1.187127735628493e-06, 1.323626312953307e-06, 1.523626312953307e-06, 1.723626312953307e-06, 1.923626312953307e-06, 2.123626312953307e-06, 2.323626312953307e-06, 2.523626312953306e-06, 2.723626312953306e-06, 2.923626312953306e-06, 3.001000000000000e-06, 3.001100000000000e-06, 3.001300000000000e-06, 3.001613625016139e-06, 3.001931234947950e-06, 3.002000000000000e-06, 3.002007742783265e-06, 3.002023228349796e-06, 3.002054199482858e-06, 3.002111059782603e-06, 3.002224780382092e-06, 3.002452221581072e-06, 3.002907103979030e-06, 3.003816868774947e-06, 3.005636398366782e-06, 3.009275457550450e-06, 3.016553575917787e-06, 3.031109812652461e-06, 3.048778833057981e-06, 3.073879085099137e-06, 3.111142007586181e-06, 3.185667852560269e-06, 3.334719542508445e-06, 3.534719542508445e-06, 3.734719542508445e-06, 3.934719542508445e-06, 4.134719542508445e-06, 4.334719542508444e-06, 4.534719542508444e-06, 4.734719542508444e-06, 4.934719542508444e-06, 5.000000000000000e-06, 5.000100000000000e-06, 5.000299999999999e-06, 5.000699999999999e-06, 5.000999999999999e-06, 5.001024535639143e-06, 5.001073606917429e-06, 5.001171749474003e-06, 5.001343721442585e-06, 5.001687665379751e-06, 5.002375553254083e-06, 5.003751329002747e-06, 5.006502880500075e-06, 5.012005983494731e-06, 5.022564010614447e-06, 5.043680064853876e-06, 5.075777875569378e-06, 5.118868429177137e-06, 5.187095272814808e-06, 5.323548960090149e-06, 5.523548960090149e-06, 5.723548960090149e-06, 5.923548960090149e-06, 6.123548960090148e-06, 6.323548960090148e-06, 6.523548960090148e-06, 6.723548960090148e-06, 6.923548960090148e-06, 7.001000000000000e-06, 7.001100000000000e-06, 7.001299999999999e-06, 7.001613624205919e-06, 7.001931233307130e-06, 7.001999999999999e-06, 7.002007742938764e-06, 7.002023228816292e-06, 7.002054200571348e-06, 7.002111061717143e-06, 7.002224784008733e-06, 7.002452228591913e-06, 7.002907117758273e-06, 7.003816896090993e-06, 7.005636452756432e-06, 7.009275566087310e-06, 7.016553792749068e-06, 7.031110246072582e-06, 7.048779342230365e-06, 7.073879805474734e-06, 7.111143208129974e-06, 7.185670013440455e-06, 7.334723624061417e-06, 7.534723624061417e-06, 7.734723624061417e-06, 7.934723624061417e-06, 8.134723624061417e-06, 8.334723624061417e-06, 8.534723624061417e-06, 8.734723624061416e-06, 8.934723624061416e-06, 8.999999999999999e-06, 9.000099999999999e-06, 9.000299999999999e-06, 9.000700000000000e-06, 9.000999999999999e-06, 9.001024535639134e-06, 9.001073606917405e-06, 9.001171749473947e-06, 9.001343721442475e-06, 9.001687665379530e-06, 9.002375553253641e-06, 9.003751329001862e-06, 9.006502880498302e-06, 9.012005983491185e-06, 9.022564010603525e-06, 9.043680064828205e-06, 9.075777875537257e-06, 9.118868429119460e-06, 9.187095272700579e-06, 9.323548959862816e-06, 9.523548959862815e-06, 9.723548959862815e-06, 9.923548959862815e-06, 9.999999999999999e-06
        };
        private double[] outputpoints = new double[]
        {
            -2.520684799868777e-06, -2.520684799882157e-06, -2.520684799882157e-06, -2.520684800014367e-06, -2.520684800430041e-06, -2.520684800671270e-06, -2.520684801252577e-06, -2.520684801567823e-06, -2.520684801548678e-06, -2.520684801306054e-06, -2.520684801011120e-06, -2.520684800353215e-06, -2.520684800141353e-06, -2.520684799982557e-06, -2.520684799957623e-06, -2.520684799915057e-06, -2.520684799830309e-06, -2.520684799916230e-06, -2.520684799835297e-06, -2.520684799913232e-06, -2.520684799785243e-06, 4.610511836450740e-02, 1.424873388182447e-01, 3.503398272101489e-01, 5.682843348480574e-01, 5.708381303658598e-01, 5.707336613116641e-01, 5.683359439764094e-01, 5.659121151188412e-01, 5.597612918198819e-01, 5.504060242620821e-01, 5.341692517964894e-01, 5.136417906113028e-01, 4.896084610635170e-01, 4.701957059773494e-01, 4.556506733758910e-01, 4.518593281223239e-01, 4.508246268390656e-01, 4.516259779734661e-01, 4.514420496441496e-01, 4.518225919428267e-01, 4.513372264736818e-01, 4.519022396640851e-01, 4.512976053095655e-01, 4.519326717146330e-01, 4.512788580666445e-01, 4.519460686233698e-01, 4.512703046525937e-01, 4.519545041016231e-01, 2.717248375561363e-01, -9.715734683862373e-02, -5.429447500891931e-01, -7.216973216692261e-01, -7.544251319372631e-01, -7.550641842952633e-01, -7.545595602052070e-01, -7.525952428774455e-01, -7.496887892495990e-01, -7.432705457579405e-01, -7.311755957206386e-01, -7.069777333664266e-01, -6.613464673284959e-01, -5.777692874788363e-01, -4.399006158837921e-01, -2.506393593428978e-01, -7.230241506514244e-02, -1.385436577862468e-02, -3.483158983954650e-04, 1.253282934414394e-04, -1.061045637124188e-04, 9.433107433010039e-05, -9.573020638624271e-05, 8.786849415430316e-05, -9.075146105519924e-05, 8.403751820275772e-05, -8.780307021020892e-05, 8.176784655474478e-05, -8.605588745040819e-05, 8.042246231057899e-05, -8.435450834397511e-05, 4.610320809817867e-02, 1.424876655170486e-01, 3.503378464268213e-01, 5.682867374468502e-01, 5.708381871683342e-01, 5.707331952703436e-01, 5.683360690179706e-01, 5.659108324654428e-01, 5.597586629701362e-01, 5.504003565225001e-01, 5.341607771837639e-01, 5.136306146411915e-01, 4.895975681602630e-01, 4.701880598324066e-01, 4.556476431553447e-01, 4.518600588199994e-01, 4.508257386781457e-01, 4.516262766713188e-01, 4.514419550192007e-01, 4.518226149751565e-01, 4.513373398874734e-01, 4.519021018351199e-01, 4.512977850239860e-01, 4.519324755715945e-01, 4.512790712277830e-01, 4.519458473300915e-01, 4.512705333331550e-01, 4.519542639291572e-01, 2.717248269210479e-01, -9.715733341740949e-02, -5.429441482246725e-01, -7.216964847671263e-01, -7.544251104127896e-01, -7.550641590790658e-01, -7.545595135661843e-01, -7.525951634712490e-01, -7.496886631450732e-01, -7.432703287544166e-01, -7.311752005003190e-01, -7.069769987368771e-01, -6.613451168772218e-01, -5.777669340467518e-01, -4.398969922283497e-01, -2.506350572863530e-01, -7.229945572752632e-02, -1.385364273751932e-02, -3.482434259523781e-04, 1.253171220315799e-04, -1.060994109030165e-04, 9.432752404397679e-05, -9.572747325693653e-05, 8.786638925060277e-05, -9.074983974243400e-05, 8.403626878112911e-05, -8.780210707348996e-05, 8.176710357579875e-05, -8.605531395126192e-05, 8.042201914430035e-05, -8.435426351879678e-05, 4.610320833027153e-02, 1.424876657418006e-01, 3.503378466346581e-01, 5.682867375492937e-01, 5.708381872679165e-01, 5.707331953681666e-01, 5.683360691144815e-01, 5.659108325582650e-01, 5.597586630574328e-01, 5.504003565990248e-01, 5.341607772451240e-01, 5.136306146838535e-01, 4.895975681863476e-01, 4.701880598510235e-01, 4.556476431647821e-01, 4.518600588205215e-01, 4.508257386769618e-01, 4.516262766701665e-01, 4.514419550197485e-01, 4.518226149746628e-01, 4.513373398877485e-01, 4.519021018348745e-01, 4.512794773540571e-01
        };

        /// <summary>
        /// Constructor
        /// </summary>
        public Main()
        {
            InitializeComponent();
            Series input = chMain.Series.Add("Reference");
            input.ChartType = SeriesChartType.FastPoint;
            Series output = chMain.Series.Add("Simulated");
            output.ChartType = SeriesChartType.FastPoint;
            Series diff = chMain.Series.Add("Difference");
            diff.ChartType = SeriesChartType.FastPoint;
            // chMain.ChartAreas[0].AxisX.IsLogarithmic = true;

            var reference = LinearSpline.Interpolate(timepoints, outputpoints);

            // Build the circuit
            NetlistReader nr = new NetlistReader();
            string netlist = string.Join(Environment.NewLine,
                ".model 1N914 D(Is = 2.52n Rs = .568 N = 1.752 Cjo = 4p M = .4 tt = 20n)",
                "V1 in 0 PULSE(-1 1 1u 1n 1n 2u 4u)",
                "D1 in out 1N914",
                "R1 out 0 1k",
                "C1 out 0 10p",
                ".tran 1n 10u"
            );
            nr.Parse(new MemoryStream(Encoding.UTF8.GetBytes(netlist)));
            SimulationConfiguration.Default.TranMaxIterations = 100;
            nr.Netlist.OnExportSimulationData += (object sender, SimulationData data) =>
            {
                double time = data.GetTime();
                double op = data.GetVoltage("OUT");
                output.Points.AddXY(time, op);
                diff.Points.AddXY(time, op - reference.Interpolate(time));
            };
            nr.Netlist.Simulate();

            for (int i = 0; i < timepoints.Length; i++)
                input.Points.AddXY(timepoints[i], outputpoints[i]);

            // chMain.ChartAreas[0].AxisX.Maximum = 1e-8;
            // chMain.ChartAreas[0].AxisX.Minimum = 8.5e-6;
            chMain.ChartAreas[0].AxisX.RoundAxisValues();
        }
    }
}
