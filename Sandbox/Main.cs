using System;
using System.Collections.Generic;
using System.Windows.Forms;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;
using SpiceSharp.Circuits;

namespace Sandbox
{
    public partial class Main : Form
    {
        /// <summary>
        /// Constructor
        /// </summary>
        public Main()
        {
            InitializeComponent();
            var plotInput = chMain.Series.Add("Input");
            plotInput.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastLine;
            var plotOutput = chMain.Series.Add("Output");
            plotOutput.ChartType = System.Windows.Forms.DataVisualization.Charting.SeriesChartType.FastLine;

            double[] reft = { 0.000000000000000e+00, 1.000000000000000e-10, 2.000000000000000e-10, 4.000000000000000e-10, 8.000000000000000e-10, 1.600000000000000e-09, 3.200000000000000e-09, 6.400000000000000e-09, 1.280000000000000e-08, 2.560000000000000e-08, 5.120000000000000e-08, 1.024000000000000e-07, 2.048000000000000e-07, 4.096000000000000e-07, 8.192000000000000e-07, 1.638400000000000e-06, 3.276800000000000e-06, 6.553600000000000e-06, 1.310720000000000e-05, 2.621440000000000e-05, 5.242880000000000e-05, 1.048576000000000e-04, 2.097152000000000e-04, 4.097152000000000e-04, 6.097152000000000e-04, 8.097152000000000e-04, 1.000000000000000e-03, 1.002943987204122e-03, 1.008831961612365e-03, 1.020607910428851e-03, 1.036526228365936e-03, 1.068362864240104e-03, 1.097704772703982e-03, 1.125782085937230e-03, 1.155007380239804e-03, 1.182023104410411e-03, 1.204683728635835e-03, 1.226954708530319e-03, 1.251016116740331e-03, 1.278677357900850e-03, 1.313106831550330e-03, 1.341831329833377e-03, 1.371196837854039e-03, 1.398666719159556e-03, 1.419907708561044e-03, 1.440791983632634e-03, 1.466162419906954e-03, 1.493797679551825e-03, 1.529907871997006e-03, 1.558117004985135e-03, 1.586803101847827e-03, 1.614918586476607e-03, 1.634676702618449e-03, 1.654023450561079e-03, 1.679095954715558e-03, 1.707311851700177e-03, 1.742888881329884e-03, 1.770578359981694e-03, 1.798701190592225e-03, 1.824098817342277e-03, 1.844051293540417e-03, 1.863596169347378e-03, 1.888173293045841e-03, 1.916371597352155e-03, 1.951715557107473e-03, 1.979620337600720e-03, 2.008008133126836e-03, 2.036283658307041e-03, 2.056039523594597e-03, 2.075390814966467e-03, 2.100505122185751e-03, 2.128734353955568e-03, 2.164327474720777e-03, 2.191990609560948e-03, 2.220081478498304e-03, 2.245450167179291e-03, 2.265372375416182e-03, 2.284884529688396e-03, 2.309484164320063e-03, 2.337680216550730e-03, 2.373034484283233e-03, 2.400930466778541e-03, 2.429307440429838e-03, 2.457592431549967e-03, 2.477330627000187e-03, 2.496662959388678e-03, 2.521790697350027e-03, 2.550018692455927e-03, 2.585618435988022e-03, 2.613276766295729e-03, 2.641361611275606e-03, 2.666724211584229e-03, 2.686639573034771e-03, 2.706144305863597e-03, 2.730749007807908e-03, 2.758944515120263e-03, 2.794301124662164e-03, 2.822195162652464e-03, 2.850569740229714e-03, 2.878856834716438e-03, 2.898591082324420e-03, 2.917919178257355e-03, 2.943049908395368e-03, 2.971277624560840e-03, 3.006878846640585e-03, 3.034536111315374e-03, 3.062619619579950e-03, 3.087980868021194e-03, 3.107894706332315e-03, 3.127397788095178e-03, 3.152003617213560e-03, 3.180199003073009e-03, 3.215556133995171e-03, 3.243449740026796e-03, 3.271823785241366e-03, 3.300111347284287e-03, 3.319844716769192e-03, 3.339171870364618e-03, 3.364303265699909e-03, 3.392530919711293e-03, 3.428132470636067e-03, 3.455789498624724e-03, 3.483872709964559e-03, 3.509233658077870e-03, 3.529147157872677e-03, 3.548649872683444e-03, 3.573255952310199e-03, 3.601451311165670e-03, 3.636808557984814e-03, 3.664702068044324e-03, 3.693075994974647e-03, 3.721363660913861e-03, 3.741096835242249e-03, 3.760423779409084e-03, 3.785555322562095e-03, 3.813782962754791e-03, 3.849384586761519e-03, 3.877041562165371e-03, 3.905124707535698e-03, 3.930485588921537e-03, 3.950399013497235e-03, 3.969901646770187e-03, 3.994507782060236e-03, 4.022703134914807e-03, 4.058060407487550e-03, 4.085953896223331e-03, 4.114327796872244e-03, 4.142615485896582e-03, 4.162348616861014e-03, 4.181675514492581e-03, 4.206807090489956e-03, 4.235034727611861e-03, 4.270636367857393e-03, 4.298293331577691e-03, 4.326376462290514e-03, 4.351737328850348e-03, 4.371650736712967e-03, 4.391153351868866e-03, 4.415759499526836e-03, 4.443954851048028e-03, 4.479312129343063e-03, 4.507205613340958e-03, 4.535579508150434e-03, 4.563867202304058e-03, 4.583600323633383e-03, 4.602927210925203e-03, 4.628058794220277e-03, 4.656286430659865e-03, 4.691888074513519e-03, 4.719545035637872e-03, 4.747628163093969e-03, 4.772989026359635e-03, 4.792902430508781e-03, 4.812405041639259e-03, 4.837011192045252e-03, 4.865206543270180e-03, 4.900563822836652e-03, 4.928457305781841e-03, 4.956831199293858e-03, 4.985118894587155e-03, 5.004852013775660e-03, 5.024178898770095e-03, 5.049310483686640e-03, 5.077538119974623e-03, 5.113139764629964e-03, 5.140796725177528e-03, 5.168879851910017e-03, 5.194240714443754e-03, 5.214154117767808e-03, 5.233656728003880e-03, 5.258262879020453e-03, 5.286458230179555e-03, 5.321815510028526e-03, 5.349708992739816e-03, 5.378082885963552e-03, 5.406370581510070e-03, 5.426103700222908e-03, 5.445430584706890e-03, 5.470562169983707e-03, 5.498789806238006e-03, 5.534391451071472e-03, 5.562048411490880e-03, 5.590131538062591e-03, 5.615492400433702e-03, 5.635405803574429e-03, 5.654908413611773e-03, 5.679514564764012e-03, 5.707709915908487e-03, 5.743067195820226e-03, 5.770960678479546e-03, 5.799334571639230e-03, 5.827622267242011e-03, 5.847355385849161e-03, 5.866682270219726e-03, 5.891813855576591e-03, 5.920041491823406e-03, 5.955643136696450e-03, 5.983300097087382e-03, 6.011383223623370e-03, 6.036744085958348e-03, 6.056657489058342e-03, 6.076160099051531e-03, 6.100766250233912e-03, 6.128961601375139e-03, 6.164318881300824e-03, 6.192212363948597e-03, 6.220586257094048e-03, 6.248873952709331e-03, 6.268607071292998e-03, 6.287933955638363e-03, 6.313065541013015e-03, 6.341293177258167e-03, 6.376894822140006e-03, 6.404551782524611e-03, 6.432634909052662e-03, 6.457995771379611e-03, 6.477909174470554e-03, 6.497411784453933e-03, 6.522017935643012e-03, 6.550213286783515e-03, 6.585570566712300e-03, 6.613464049357507e-03, 6.641837942499796e-03, 6.670125638117857e-03, 6.689858756696307e-03, 6.709185641036073e-03, 6.734317226414676e-03, 6.762544862659458e-03, 6.798146507543250e-03, 6.825803467926449e-03, 6.853886594452737e-03, 6.879247456777903e-03, 6.899160859866835e-03, 6.918663469848034e-03, 6.943269621038601e-03, 6.971464972178944e-03, 7.006822252108418e-03, 7.034715734753055e-03, 7.063089627894641e-03, 7.091377323513319e-03, 7.111110442090609e-03, 7.130437326429131e-03, 7.155568911808612e-03, 7.183796548053312e-03, 7.219398192937538e-03, 7.247055153320425e-03, 7.275138279846321e-03, 7.300499142171090e-03, 7.320412545259575e-03, 7.339915155240291e-03, 7.364521306431188e-03, 7.392716657571496e-03, 7.428073937501122e-03, 7.455967420145633e-03, 7.484341313287063e-03, 7.512629008905878e-03, 7.532362127482910e-03, 7.551689011821155e-03, 7.576820597200832e-03, 7.605048233445513e-03, 7.640649878329836e-03, 7.668306838712654e-03, 7.696389965238462e-03, 7.721750827563142e-03, 7.741664230651529e-03, 7.761166840632137e-03, 7.785772991823108e-03, 7.813968342963409e-03, 7.849325622893069e-03, 7.877219105537552e-03, 7.905592998678948e-03, 7.933880694297794e-03, 7.953613812874769e-03, 7.972940697212954e-03, 7.998072282592673e-03, 8.026299918837351e-03, 8.061901563721694e-03, 8.089558524104496e-03, 8.117641650630286e-03, 8.143002512954947e-03, 8.162915916043312e-03, 8.182418526023897e-03, 8.207024677214883e-03, 8.235220028355181e-03, 8.270577308284848e-03, 8.298470790929324e-03, 8.326844684070713e-03, 8.355132379689566e-03, 8.374865498266529e-03, 8.394192382604700e-03, 8.419323967984430e-03, 8.447551604229107e-03, 8.483153249113456e-03, 8.510810209496254e-03, 8.538893336022039e-03, 8.564254198346695e-03, 8.584167601435055e-03, 8.603670211415632e-03, 8.628276362606623e-03, 8.656471713746920e-03, 8.691828993676589e-03, 8.719722476321063e-03, 8.748096369462451e-03, 8.776384065081303e-03, 8.796117183658263e-03, 8.815444067996430e-03, 8.840575653376162e-03, 8.868803289620839e-03, 8.904404934505190e-03, 8.932061894887988e-03, 8.960145021413773e-03, 8.985505883738429e-03, 9.005419286826787e-03, 9.024921896807364e-03, 9.049528047998356e-03, 9.077723399138654e-03, 9.113080679068323e-03, 9.140974161712797e-03, 9.169348054854184e-03, 9.197635750473039e-03, 9.217368869049999e-03, 9.236695753388166e-03, 9.261827338767898e-03, 9.290054975012573e-03, 9.325656619896924e-03, 9.353313580279722e-03, 9.381396706805505e-03, 9.406757569130161e-03, 9.426670972218519e-03, 9.446173582199097e-03, 9.470779733390089e-03, 9.498975084530386e-03, 9.534332364460055e-03, 9.562225847104529e-03, 9.590599740245917e-03, 9.618887435864771e-03, 9.638620554441731e-03, 9.657947438779898e-03, 9.683079024159630e-03, 9.711306660404305e-03, 9.746908305288656e-03, 9.774565265671454e-03, 9.802648392197237e-03, 9.828009254521894e-03, 9.847922657610251e-03, 9.867425267590829e-03, 9.892031418781821e-03, 9.920226769922118e-03, 9.955584049851788e-03, 9.983477532496262e-03, 1.000000000000000e-02 };
            double[] refv = { 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 8.592588175108461e-03, 4.266761058935425e-02, 2.053359840186468e-01, 5.840218254278252e-01, 1.478847026083705e+00, 1.975781543017752e+00, 1.801440960234887e+00, 1.069432263009271e+00, 3.303805762844808e-01, 1.476917214546986e-02, 1.419410734289233e-01, 6.946652279756287e-01, 1.488605048416720e+00, 1.993851620358176e+00, 1.699547965329022e+00, 9.101387806069756e-01, 2.139702479327437e-01, 4.388302858272274e-03, 1.925174499804016e-01, 8.189650571291821e-01, 1.595474999740234e+00, 1.989909984006199e+00, 1.581661404112572e+00, 7.751690636404553e-01, 1.292749968414409e-01, 9.198793032138650e-03, 2.339162080705972e-01, 8.777947980565250e-01, 1.653713061158656e+00, 1.981301046654959e+00, 1.541675428030306e+00, 7.424945106282497e-01, 1.488038622324031e-01, 6.454093266582953e-03, 2.165630521890776e-01, 8.370745424678335e-01, 1.621765915909820e+00, 1.988191307745510e+00, 1.576025539270363e+00, 7.760236080225922e-01, 1.276663339292775e-01, 9.527106174514646e-03, 2.360878771951434e-01, 8.822918185446456e-01, 1.657386259760311e+00, 1.980395350157520e+00, 1.537836156750257e+00, 7.388947308426433e-01, 1.472803117070139e-01, 6.592612520541644e-03, 2.172647854408625e-01, 8.388030884190413e-01, 1.623087161705018e+00, 1.987951710265514e+00, 1.574631387556960e+00, 7.746358012759038e-01, 1.268610131692118e-01, 9.647040045249453e-03, 2.364857449776141e-01, 8.832703197272105e-01, 1.658101635378409e+00, 1.980200686644542e+00, 1.537007580877707e+00, 7.380978905819473e-01, 1.469393834482176e-01, 6.624189811770872e-03, 2.174200635786356e-01, 8.391877303830996e-01, 1.623379974422714e+00, 1.987897892905594e+00, 1.574320701372763e+00, 7.743264739035707e-01, 1.266819042309808e-01, 9.673916574334012e-03, 2.365740090156797e-01, 8.834876813250074e-01, 1.658260370033160e+00, 1.980157270470030e+00, 1.536823376214046e+00, 7.379207854214052e-01, 1.468636290827362e-01, 6.631238816954341e-03, 2.174545646963422e-01, 8.392732195375244e-01, 1.623445032251722e+00, 1.987885905317353e+00, 1.574251626073552e+00, 7.742577084586408e-01, 1.266421028031089e-01, 9.679899229481755e-03, 2.365936140616511e-01, 8.835359743122443e-01, 1.658295629244781e+00, 1.980147615699190e+00, 1.536782442617263e+00, 7.378814317927175e-01, 1.468467971181093e-01, 6.632806652425850e-03, 2.174622304682647e-01, 8.392922155670500e-01, 1.623459487292973e+00, 1.987883240326730e+00, 1.574236276116816e+00, 7.742424277417103e-01, 1.266332590985148e-01, 9.681229052172164e-03, 2.365979697769835e-01, 8.835467043636991e-01, 1.658303462964041e+00, 1.980145470112149e+00, 1.536773347359897e+00, 7.378726877118977e-01, 1.468430572325108e-01, 6.633155088362492e-03, 2.174639337182913e-01, 8.392964363383113e-01, 1.623462699038977e+00, 1.987882648122133e+00, 1.574232865417977e+00, 7.742390324466220e-01, 1.266312941118867e-01, 9.681524550881537e-03, 2.365989375535189e-01, 8.835490884567918e-01, 1.658305203505795e+00, 1.980144993366493e+00, 1.536771326481165e+00, 7.378707448668868e-01, 1.468422262708127e-01, 6.633232510937016e-03, 2.174643121616343e-01, 8.392973741501711e-01, 1.623463412653228e+00, 1.987882516537206e+00, 1.574232107593051e+00, 7.742382780452000e-01, 1.266308575129223e-01, 9.681590208752458e-03, 2.365991525820161e-01, 8.835496181756458e-01, 1.658305590233748e+00, 1.980144887437893e+00, 1.536770877463598e+00, 7.378703131878553e-01, 1.468420416402842e-01, 6.633249713573560e-03, 2.174643962475638e-01, 8.392975825217580e-01, 1.623463571210417e+00, 1.987882487300311e+00, 1.574231939212463e+00, 7.742381104253235e-01, 1.266307605054255e-01, 9.681604797272094e-03, 2.365992003589349e-01, 8.835497358733065e-01, 1.658305676160366e+00, 1.980144863901679e+00, 1.536770777696824e+00, 7.378702172735290e-01, 1.468420006174207e-01, 6.633253535819943e-03, 2.174644149305291e-01, 8.392976288196293e-01, 1.623463606440072e+00, 1.987882480804187e+00, 1.574231901800143e+00, 7.742380731820282e-01, 1.266307389514303e-01, 9.681608038683565e-03, 2.365992109744380e-01, 8.835497620244290e-01, 1.658305695252310e+00, 1.980144858672190e+00, 1.536770755529746e+00, 7.378701959624223e-01, 1.468419915025926e-01, 6.633254385081156e-03, 2.174644190816775e-01, 8.392976391065056e-01, 1.623463614267711e+00, 1.987882479360818e+00, 1.574231893487539e+00, 7.742380649069800e-01, 1.266307341623719e-01, 9.681608758890584e-03, 2.365992133330856e-01, 8.835497678349175e-01, 1.658305699494327e+00, 1.980144857510255e+00, 1.536770750604467e+00, 7.378701912273293e-01, 1.468419894773781e-01, 6.633254573777449e-03, 2.174644200040167e-01, 8.392976413921368e-01, 1.623463616006927e+00, 1.987882479040118e+00, 1.574231891640570e+00, 7.742380630683559e-01, 1.266307330982959e-01, 9.681608918912751e-03, 2.365992138571514e-01, 8.835497691259449e-01, 1.658305700436856e+00, 1.980144857252084e+00, 1.536770749510123e+00, 7.378701901752462e-01, 1.468419890274001e-01, 6.633254615705223e-03, 2.174644202089514e-01, 8.392976418999774e-01, 1.623463616393360e+00, 1.987882478968861e+00, 1.574231891230193e+00, 7.742380626598344e-01, 1.266307328618705e-01, 9.681608954468521e-03, 2.365992139735929e-01, 8.835497694127952e-01, 1.658305700646274e+00, 1.980144857194722e+00, 1.536770749266973e+00, 7.378701899414838e-01, 1.468419889274197e-01, 6.633254625021933e-03, 2.174644202544863e-01, 8.392976420128156e-01, 1.623463616479222e+00, 1.987882478953028e+00, 1.574231891139011e+00, 7.742380625690634e-01, 1.266307328093380e-01, 9.681608962367807e-03, 2.365992139994650e-01, 8.835497694765317e-01, 1.658305700692806e+00, 1.980144857181976e+00, 1.536770749212947e+00, 7.378701898895449e-01, 1.468419889052056e-01, 6.633254627091728e-03, 2.174644202646037e-01, 8.392976420378875e-01, 1.623463616498299e+00, 1.987882478949509e+00, 1.574231891118750e+00, 7.742380625488946e-01, 1.266307327976661e-01, 9.681608964123872e-03, 2.365992140052136e-01, 8.835497694906935e-01, 1.658305700703145e+00, 1.980144857179144e+00, 1.536770749200943e+00, 7.378701898780041e-01, 1.468419889002685e-01, 6.633254627550482e-03, 2.174644202668507e-01, 8.392976420434577e-01, 1.623463616502540e+00, 1.987882478948730e+00, 1.574231891114250e+00, 7.742380625444135e-01, 1.266307327950711e-01, 9.681608964512024e-03, 2.365992140064898e-01, 8.835497694938400e-01, 1.658305700705443e+00, 1.980144857178517e+00, 1.536770749198277e+00, 7.378701898754397e-01, 1.468419888991703e-01, 6.633254627650957e-03, 2.174644202673487e-01, 8.392976420446943e-01, 1.623463616503481e+00, 1.987882478948558e+00, 1.574231891113252e+00, 7.742380625434178e-01, 1.266307327944934e-01, 9.681608964596194e-03, 2.365992140067709e-01, 8.835497694945368e-01, 1.658305700705955e+00, 1.980144857178380e+00, 1.536770749197687e+00, 7.378701898748709e-01, 1.468419888989249e-01, 6.633254627670780e-03, 2.174644202674570e-01, 8.392976420449683e-01, 1.623463616503692e+00, 1.987882478948522e+00, 1.574231891113032e+00, 7.742380625431997e-01, 1.266307327943664e-01, 9.681608964614483e-03, 2.365992140068335e-01, 8.835497694946927e-01, 1.658305700706069e+00, 1.980144857178350e+00, 1.536770749197555e+00, 7.378701898747436e-01, 1.468419888988705e-01, 6.633254627675736e-03, 2.174644202674815e-01, 8.392976420450298e-01, 1.623463616503739e+00, 1.987882478948514e+00, 1.574231891112982e+00, 7.742380625431482e-01, 1.266307327943366e-01, 9.681608964618501e-03, 2.365992140068477e-01, 8.835497694947277e-01, 1.658305700706094e+00, 1.980144857178342e+00, 1.536770749197526e+00, 7.378701898747155e-01, 1.468419888988596e-01, 6.633254627678218e-03, 2.174644202674883e-01, 8.392976420450431e-01, 1.623463616503749e+00, 1.987882478948511e+00, 1.574231891112971e+00, 7.742380625431373e-01, 1.266307327943303e-01, 9.681608964619507e-03, 2.365992140068503e-01, 8.835497694947347e-01, 1.658305700706100e+00, 1.980144857178342e+00, 1.536770749197521e+00, 7.378701898747098e-01, 1.468419888988553e-01, 6.633254627675772e-03, 2.174644202674872e-01, 8.392976420450452e-01, 1.623463616503752e+00, 1.987882478948513e+00, 1.574231891112971e+00, 1.103006724925385e+00 };
            
            // Build circuit
            Circuit ckt = new Circuit();
            ckt.Objects.Add(
                new Inductor("L1", "IN", "OUT", 1e-3),
                new Voltagesource("V1", "IN", "0", new Pulse(0, 1, 1e-3, 1e-10, 1.0, 10.0, 20.0)),
                new Capacitor("C1", "OUT", "0", 1e-6)
                );

            // Create simulation, exports and references
            Transient tran = new Transient("tran", 1e-8, 10e-3);
            Func<State, double> export = null;

            tran.InitializeSimulationExport += (object sender, InitializationDataEventArgs args) =>
            {
                export = tran.CreateExport("C1", "v");
            };
            tran.OnExportSimulationData += (object sender, SimulationDataEventArgs data) =>
            {
                plotInput.Points.AddXY(data.GetTime(), data.GetVoltage("OUT"));
            };
            tran.Run(ckt);

            for (int i = 0; i < reft.Length; i++)
                plotOutput.Points.AddXY(reft[i], refv[i]);
        }

        /// <summary>
        /// Assign parameters to an entity
        /// </summary>
        /// <param name="src">String with parameters</param>
        /// <param name="e">Entity</param>
        void AssignParameters(string src, Entity e)
        {
            // Split in parameters
            string[] assignments = src.Split(' ');

            // Assign parameters
            foreach (var assignment in assignments)
            {
                // Split in name and value
                if (string.IsNullOrWhiteSpace(assignment))
                    continue;
                string[] parts = assignment.Split('=');
                if (parts.Length != 2)
                    continue;
                string parameter = parts[0].Trim();
                double value = double.Parse(parts[1], System.Globalization.CultureInfo.InvariantCulture);

                // Assign the parameter
                e.Parameters.Set(parameter.ToLower(), value);
            }
        }
    }
}