using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace SpiceSharpTest.Models.Transistors
{
    /// <summary>
    /// Model part of the ntd20n06 (ONSemi)
    /// Instance: M1 9 7 8 8 MM L = 100u W=100u
    /// .MODEL MM NMOS LEVEL = 1 IS=1e-32 VTO=3.03646 LAMBDA=0 KP=5.28747 CGSO=6.5761e-06 CGDO=1e-11
    /// </summary>
    [TestClass]
    public class SpiceSharpMOS1Test : Framework
    {
        [TestMethod]
        public void TestMOS1_DC()
        {
            // Simulation results by Spice 3f5
            double[] reference = new double[]
            {
                -9.806842412468131e-31, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.680575723780237e-01, -1.886410671900499e+00, -3.208278171900499e+00, -4.530145671900499e+00, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -5.680575723785246e-01, -2.454468244278523e+00, -5.094688843800999e+00, -7.738423843800998e+00, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -5.680575723790238e-01, -2.454468244279024e+00, -5.662746416179022e+00, -9.624834515701494e+00, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -5.680575723795247e-01, -2.454468244279525e+00, -5.662746416179523e+00, -1.019289208807952e+01, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -5.680575723800239e-01, -2.454468244280026e+00, -5.662746416180024e+00, -1.019289208808002e+01, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -5.680575723805248e-01, -2.454468244280523e+00, -5.662746416180521e+00, -1.019289208808052e+01, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -5.680575723810239e-01, -2.454468244281024e+00, -5.662746416181022e+00, -1.019289208808102e+01, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -5.680575723815249e-01, -2.454468244281525e+00, -5.662746416181523e+00, -1.019289208808152e+01, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -5.680575723820240e-01, -2.454468244282026e+00, -5.662746416182024e+00, -1.019289208808202e+01, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.680575723825250e-01, -2.454468244282523e+00, -5.662746416182522e+00, -1.019289208808252e+01
            };

            var netlist = Run(
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "M1 D G 0 0 MM w = 100u l = 100u",
                "V1 G 0 0",
                "V2 D 0 0",
                ".SAVE I(V2)",
                ".DC V1 0 5 0.5 V2 0 5 0.5"
            );
            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS1_AC()
        {
            // Simulation by Spice 3f5
            double[] reference = new double[]
            {
                -1.688264281083676e-03, -6.256171908921069e-01, -4.240681451402584e-03, -9.915255104329067e-01, -1.065181562150848e-02, -1.571418573953089e+00, -2.675429265826203e-02, -2.490357609011980e+00, -6.719202140507280e-02, -3.946262298301279e+00, -1.687048030969052e-01, -6.251664871263374e+00, -4.233015949949251e-01, -9.897332180343838e+00, -1.060358405820734e+00, -1.564303168844958e+01, -2.645208298269774e+00, -2.462227160463906e+01, -6.531786973747334e+00, -3.836191269368651e+01, -1.573677982895236e+01, -5.831551384917359e+01, -3.584989404952447e+01, -8.382163136661943e+01, -7.298715801766126e+01, -1.076749482750201e+02, -1.242129947055924e+02, -1.156205991749138e+02, -1.723768968647264e+02, -1.012388382455914e+02, -2.038436403302176e+02, -7.553792287868039e+01, -2.198184972018414e+02, -5.139626354807145e+01, -2.268974568604466e+02, -3.347306931637866e+01, -2.298441757431590e+02, -2.139419177413151e+01, -2.310386967836807e+02, -1.356870019889037e+01, -2.315177067081831e+02, -8.578581367969413e+00, -2.317089572179777e+02, -5.416492823357626e+00, -2.317851833738230e+02, -3.417594558206259e+00, -2.318155434938701e+02, -2.154886248110806e+00, -2.318276322425509e+02, -1.356934399871164e+00, -2.318324450945829e+02, -8.517828801859809e-01, -2.318343608887390e+02, -5.304653655133196e-01, -2.318351228545550e+02, -3.236431096441236e-01, -2.318354243553034e+02, -1.866778920706296e-01, -2.318355397514484e+02, -9.000682163588355e-02, -2.318355740522236e+02, -1.276368093331558e-02, -2.318355584710393e+02, 6.172442161761246e-02, -2.318354788291473e+02, 1.495357217394321e-01, -2.318352626532035e+02, 2.696241584767764e-01, -2.318347132261877e+02, 4.479101964820005e-01, -2.318333305837931e+02, 7.228742344584919e-01, -2.318298565981921e+02, 1.153856507515514e+00, -2.318211303931419e+02, 1.833841379822644e+00, -2.317992138806615e+02, 2.909431239455916e+00, -2.317441802215046e+02, 4.612105461508964e+00, -2.316060565931579e+02, 7.306654143322226e+00, -2.312598277395532e+02, 1.156384690656623e+01, -2.303946694274438e+02, 1.825970689572349e+01, -2.282496552817779e+02, 2.867173655595526e+01, -2.230330396146007e+02, 4.440780279305579e+01, -2.109200301821816e+02, 6.657634054390823e+01
            };

            var netlist = Run(
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "M1 out g 0 0 MM w = 100u l = 100u",
                "V1 in 0 DC 0 AC 1 0",
                "V2 vdd 0 DC 5.0",
                "R1 vdd out 10k",
                "R2 out g 10k",
                "Cin in g 1u",
                ".SAVE VR(out) VI(out)",
                ".AC dec 5 10 10g"
            );
            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS1_Transient()
        {
            // Provided by Spice 3f5
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000505416909167e-06, 1.000916250727500e-06, 1.001000000000000e-06, 1.001040727433433e-06, 1.001122182300300e-06, 1.001285092034034e-06, 1.001610911501501e-06, 1.002262550436436e-06, 1.003565828306307e-06, 1.006172384046046e-06, 1.011385495525526e-06, 1.021811718484486e-06, 1.042664164402405e-06, 1.084369056238244e-06, 1.167778839909921e-06, 1.334598407253275e-06, 1.534598407253275e-06, 1.734598407253275e-06, 1.934598407253275e-06, 2.134598407253274e-06, 2.334598407253274e-06, 2.534598407253274e-06, 2.734598407253274e-06, 2.934598407253274e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.234987431524397e-06, 3.325439370636820e-06, 3.420856173579678e-06, 3.501000000000000e-06, 3.511070126950724e-06, 3.531210380852173e-06, 3.571490888655072e-06, 3.652051904260869e-06, 3.813173935472463e-06, 4.013173935472463e-06, 4.213173935472463e-06, 4.413173935472463e-06, 4.613173935472462e-06, 4.813173935472462e-06, 5.013173935472462e-06, 5.213173935472462e-06, 5.413173935472462e-06, 5.613173935472461e-06, 5.813173935472461e-06, 6.013173935472461e-06, 6.213173935472461e-06, 6.413173935472460e-06, 6.613173935472460e-06, 6.813173935472460e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000505416909549e-06, 7.000916250728647e-06, 7.001000000000000e-06, 7.001040727433111e-06, 7.001122182299335e-06, 7.001285092031782e-06, 7.001610911496677e-06, 7.002262550426466e-06, 7.003565828286043e-06, 7.006172384005199e-06, 7.011385495443511e-06, 7.021811718320133e-06, 7.042664164073380e-06, 7.084369055579872e-06, 7.167778838592857e-06, 7.334598404618826e-06, 7.534598404618826e-06, 7.734598404618826e-06, 7.934598404618826e-06, 8.134598404618826e-06, 8.334598404618826e-06, 8.534598404618825e-06, 8.734598404618825e-06, 8.934598404618825e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.234987431524396e-06, 9.325439370636819e-06, 9.420856173579678e-06, 9.500999999999999e-06, 9.511070126950724e-06, 9.531210380852173e-06, 9.571490888655071e-06, 9.652051904260870e-06, 9.813173935472464e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 5.003960391035683e+00, 5.004038814719480e+00, 5.003961923904320e+00, 5.822926169346066e-04, 4.810560374122478e-04, 4.816080793679862e-04, 4.816080824751261e-04, 4.816080793679973e-04, 4.816080824751207e-04, 4.816080793680000e-04, 4.816080824751193e-04, 4.816080793680006e-04, 4.816080824751191e-04, 4.816080793680011e-04, 4.816080824751189e-04, 4.816080793680010e-04, 4.816080824751191e-04, 4.816080793680009e-04, 4.816080824751189e-04, 4.816080793680010e-04, 4.816080824751189e-04, 4.816080793680010e-04, 4.816080824751189e-04, 4.816080793680010e-04, 4.816080824751189e-04, 4.816080793680010e-04, 4.816080824751188e-04, 5.243402581575843e-04, 6.374704766839068e-04, 1.121520168458353e-03, -1.720170200560100e+01, 4.999968188570249e+00, 5.000015800431791e+00, 4.999968190756332e+00, 4.999999991842038e+00, 4.999999998157336e+00, 4.999999991842977e+00, 4.999999998156865e+00, 4.999999991843213e+00, 4.999999998156724e+00, 4.999999991843340e+00, 4.999999998156598e+00, 4.999999991843466e+00, 4.999999998156472e+00, 4.999999991843592e+00, 4.999999998156345e+00, 4.999999991843718e+00, 4.999999998156220e+00, 4.999999991843845e+00, 4.999999998156093e+00, 4.999999991843971e+00, 4.999999998155968e+00, 4.999999991844097e+00, 4.999999998155841e+00, 4.999999991844228e+00, 5.003960391004448e+00, 5.004038814750084e+00, 5.003961923874295e+00, 5.822926152947390e-04, 4.810560374114067e-04, 4.816080793679895e-04, 4.816080824751229e-04, 4.816080793680006e-04, 4.816080824751175e-04, 4.816080793680033e-04, 4.816080824751161e-04, 4.816080793680040e-04, 4.816080824751158e-04, 4.816080793680041e-04, 4.816080824751156e-04, 4.816080793680043e-04, 4.816080824751156e-04, 4.816080793680043e-04, 4.816080824751157e-04, 4.816080793680042e-04, 4.816080824751155e-04, 4.816080793680042e-04, 4.816080824751155e-04, 4.816080793680042e-04, 4.816080824751155e-04, 4.816080793680042e-04, 4.816080824751157e-04, 5.243402581575805e-04, 6.374704766839011e-04, 1.121520168458326e-03, -1.720170200561121e+01, 4.999968188570249e+00, 5.000015800431791e+00, 4.999968190756332e+00, 4.999999991842038e+00, 4.999999998157336e+00, 4.999999991842977e+00, 4.999999998156865e+00, 4.999999991843213e+00, 4.999999998156719e+00
            };

            // Parse the netlist
            var netlist = Run(
                "M1 out in 0 0 MM L = 100u W = 100u",
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "V1 in 0 PULSE(1 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 5",
                "R1 out vdd 1k",
                ".SAVE V(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }

        [TestMethod]
        public void TestMOS1_Noise()
        {
            // Provided by Spice 3f5
            double[] reference_in = new double[]
            {
                2.815379564675864e-12, 1.644868840839549e-12, 1.010121306101684e-12, 6.537880726721799e-13, 4.448524865997785e-13, 3.160333336157883e-13, 2.323257132196350e-13, 1.751655483262268e-13, 1.344386048382044e-13, 1.044322995501785e-13, 8.177248667148335e-14, 6.436215686569252e-14, 5.082789164771354e-14, 4.022525188195949e-14, 3.187747693804598e-14, 2.528380544270212e-14, 2.006491938974725e-14, 1.592876491956225e-14, 1.264799208788146e-14, 1.004433497404203e-14, 7.977357413355818e-15, 6.336091407348683e-15, 5.032685020810389e-15, 3.997501981674192e-15, 3.175301978989497e-15, 2.522243079680978e-15, 2.003518973571566e-15, 1.591491353272600e-15, 1.264211017007844e-15, 1.004245449843196e-15, 7.977486981440409e-16, 6.337231268378405e-16, 5.034333047893085e-16, 3.999405843517482e-16, 3.177334786554185e-16, 2.524340970390206e-16, 2.005649771592597e-16, 1.593638826030865e-16, 1.266366961773762e-16, 1.006405713131741e-16, 7.999111715405073e-17, 6.358867367592469e-17, 5.055975025237714e-17, 4.021050881748337e-17, 3.198981431322685e-17, 2.545988466054381e-17, 2.027297722561883e-17, 1.615287023394526e-17, 1.288015294111360e-17, 1.028054120362606e-17, 8.215596208788723e-18, 6.575352100860561e-18, 5.272459896934062e-18, 4.237535834307345e-18, 3.415466431655031e-18, 2.762473494901996e-18, 2.243782768585602e-18, 1.831772079846699e-18, 1.504500356938407e-18, 1.244539187109050e-18, 1.038044690046574e-18, 8.740202807553306e-19, 7.437310612966987e-19, 6.402386556161864e-19, 5.580317157140351e-19, 4.927324222647428e-19, 4.408633497727489e-19, 3.996622809833569e-19, 3.669351087408033e-19, 3.409389917808688e-19, 3.202895420778084e-19, 3.038871011332858e-19, 2.908581791507522e-19, 2.805089385176244e-19, 2.722882444208535e-19, 2.657583149061083e-19, 2.605714073887111e-19, 2.564513000872298e-19, 2.531785821973098e-19, 2.505789694518999e-19, 2.485140228257554e-19, 2.468737761164706e-19, 2.455708797860733e-19, 2.445359491890543e-19, 2.437138694434664e-19, 2.430608601350282e-19, 2.425421434899278e-19, 2.421300917602111e-19, 2.418027550399525e-19, 2.415426909176026e-19, 2.413360333294781e-19
            };
            double[] reference_out = new double[]
            {
                1.101938772677249e-12, 1.020351798553683e-12, 9.930914904110209e-13, 1.018704151068570e-12, 1.098549779218339e-12, 1.236872518232169e-12, 1.441022728380007e-12, 1.721840550874621e-12, 2.094217487153999e-12, 2.577858124390719e-12, 3.198267097692130e-12, 3.987983099859464e-12, 4.988064706261346e-12, 6.249786808519018e-12, 7.836401914012315e-12, 9.824601582961330e-12, 1.230487975385098e-11, 1.537918793701761e-11, 1.915286183784488e-11, 2.371564318075358e-11, 2.910415518231322e-11, 3.523777729653164e-11, 4.182805832714524e-11, 4.828952148482491e-11, 5.372934740827330e-11, 5.712303094004328e-11, 5.769531786489053e-11, 5.530480561891652e-11, 5.052178742786626e-11, 4.432835400406183e-11, 3.770017350647562e-11, 3.134531801206027e-11, 2.565584102156048e-11, 2.077916019829584e-11, 1.671370313489508e-11, 1.338397388087558e-11, 1.068731671781018e-11, 8.518878155014311e-12, 6.783039968978641e-12, 5.397456921217182e-12, 4.293446467982328e-12, 3.414789199740856e-12, 2.715987838819629e-12, 2.160479000532345e-12, 1.719006299308645e-12, 1.368223534346394e-12, 1.089532434335449e-12, 8.681329107747076e-13, 6.922553133235565e-13, 5.525438940163232e-13, 4.415637162479891e-13, 3.534072935825517e-13, 2.833812867202454e-13, 2.277572142155273e-13, 1.835732224046120e-13, 1.484765190559835e-13, 1.205981604962914e-13, 9.845356466124910e-14, 8.086347233940640e-14, 6.689115769628357e-14, 5.579254942299496e-14, 4.697660884412611e-14, 3.997385626141668e-14, 3.441137009036628e-14, 2.999292772256991e-14, 2.648323069715085e-14, 2.369537418245358e-14, 2.148089349130362e-14, 1.972185755582100e-14, 1.832458826459864e-14, 1.721467110986965e-14, 1.633299130424805e-14, 1.563258405234841e-14, 1.507613088730997e-14, 1.463396817940087e-14, 1.428250087013048e-14, 1.400293554605381e-14, 1.378026315480551e-14, 1.360243367639641e-14, 1.345967328032927e-14, 1.334389898454301e-14, 1.324818629450979e-14, 1.316624109090014e-14, 1.309181726819219e-14, 1.301800572736213e-14, 1.293629969876902e-14, 1.283532383362070e-14, 1.269912466960263e-14, 1.250502043061476e-14, 1.222133156026873e-14, 1.180607868779705e-14
            };

            var netlist = Run(
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11 KF=1e-25",
                "M1 out g 0 0 MM w = 100u l = 100u",
                "V1 in 0 DC 0 AC 1 0",
                "V2 vdd 0 DC 5.0",
                "R1 vdd out 10k",
                "R2 out g 10k",
                "Cin in g 1u",
                ".NOISE v(out) V1 dec 10 10 10g");
            TestNoise(netlist, reference_in, reference_out);
        }
    }
}
