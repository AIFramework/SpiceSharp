using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace SpiceSharpTest.Models.Transistors
{
    /// <summary>
    /// Model part of the ntd20n06 (ONSemi)
    /// Instance: M1 9 7 8 8 MM L = 100u W=100u
    /// .MODEL MM NMOS LEVEL = 1 IS=1e-32 VTO=3.03646 LAMBDA=0 KP=5.28747 CGSO=6.5761e-06 CGDO=1e-11
    /// </summary>
    [TestClass]
    public class SpiceSharpMOS1Test : Framework
    {
        [TestMethod]
        public void TestMOS1_DC()
        {
            // Simulation results by Spice 3f5
            double[] reference = new double[]
            {
                -9.806842412468131e-31, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.000000000000000e-13, -5.680575723780237e-01, -1.886410671900499e+00, -3.208278171900499e+00, -4.530145671900499e+00, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -1.000000000000000e-12, -5.680575723785246e-01, -2.454468244278523e+00, -5.094688843800999e+00, -7.738423843800998e+00, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -1.500000000000000e-12, -5.680575723790238e-01, -2.454468244279024e+00, -5.662746416179022e+00, -9.624834515701494e+00, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -2.000000000000000e-12, -5.680575723795247e-01, -2.454468244279525e+00, -5.662746416179523e+00, -1.019289208807952e+01, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -2.500000000000000e-12, -5.680575723800239e-01, -2.454468244280026e+00, -5.662746416180024e+00, -1.019289208808002e+01, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -3.000000000000000e-12, -5.680575723805248e-01, -2.454468244280523e+00, -5.662746416180521e+00, -1.019289208808052e+01, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -3.500000000000000e-12, -5.680575723810239e-01, -2.454468244281024e+00, -5.662746416181022e+00, -1.019289208808102e+01, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -4.000000000000000e-12, -5.680575723815249e-01, -2.454468244281525e+00, -5.662746416181523e+00, -1.019289208808152e+01, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -4.500000000000000e-12, -5.680575723820240e-01, -2.454468244282026e+00, -5.662746416182024e+00, -1.019289208808202e+01, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.000000000000000e-12, -5.680575723825250e-01, -2.454468244282523e+00, -5.662746416182522e+00, -1.019289208808252e+01
            };

            var netlist = Run(
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "M1 D G 0 0 MM w = 100u l = 100u",
                "V1 G 0 0",
                "V2 D 0 0",
                ".SAVE I(V2)",
                ".DC V1 0 5 0.5 V2 0 5 0.5"
            );
            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS1_AC()
        {
            // Simulation by Spice 3f5
            double[] reference = new double[]
            {
                -1.688264281083676e-03, -6.256171908921069e-01, -4.240681451402584e-03, -9.915255104329067e-01, -1.065181562150848e-02, -1.571418573953089e+00, -2.675429265826203e-02, -2.490357609011980e+00, -6.719202140507280e-02, -3.946262298301279e+00, -1.687048030969052e-01, -6.251664871263374e+00, -4.233015949949251e-01, -9.897332180343838e+00, -1.060358405820734e+00, -1.564303168844958e+01, -2.645208298269774e+00, -2.462227160463906e+01, -6.531786973747334e+00, -3.836191269368651e+01, -1.573677982895236e+01, -5.831551384917359e+01, -3.584989404952447e+01, -8.382163136661943e+01, -7.298715801766126e+01, -1.076749482750201e+02, -1.242129947055924e+02, -1.156205991749138e+02, -1.723768968647264e+02, -1.012388382455914e+02, -2.038436403302176e+02, -7.553792287868039e+01, -2.198184972018414e+02, -5.139626354807145e+01, -2.268974568604466e+02, -3.347306931637866e+01, -2.298441757431590e+02, -2.139419177413151e+01, -2.310386967836807e+02, -1.356870019889037e+01, -2.315177067081831e+02, -8.578581367969413e+00, -2.317089572179777e+02, -5.416492823357626e+00, -2.317851833738230e+02, -3.417594558206259e+00, -2.318155434938701e+02, -2.154886248110806e+00, -2.318276322425509e+02, -1.356934399871164e+00, -2.318324450945829e+02, -8.517828801859809e-01, -2.318343608887390e+02, -5.304653655133196e-01, -2.318351228545550e+02, -3.236431096441236e-01, -2.318354243553034e+02, -1.866778920706296e-01, -2.318355397514484e+02, -9.000682163588355e-02, -2.318355740522236e+02, -1.276368093331558e-02, -2.318355584710393e+02, 6.172442161761246e-02, -2.318354788291473e+02, 1.495357217394321e-01, -2.318352626532035e+02, 2.696241584767764e-01, -2.318347132261877e+02, 4.479101964820005e-01, -2.318333305837931e+02, 7.228742344584919e-01, -2.318298565981921e+02, 1.153856507515514e+00, -2.318211303931419e+02, 1.833841379822644e+00, -2.317992138806615e+02, 2.909431239455916e+00, -2.317441802215046e+02, 4.612105461508964e+00, -2.316060565931579e+02, 7.306654143322226e+00, -2.312598277395532e+02, 1.156384690656623e+01, -2.303946694274438e+02, 1.825970689572349e+01, -2.282496552817779e+02, 2.867173655595526e+01, -2.230330396146007e+02, 4.440780279305579e+01, -2.109200301821816e+02, 6.657634054390823e+01
            };

            var netlist = Run(
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "M1 out g 0 0 MM w = 100u l = 100u",
                "V1 in 0 DC 0 AC 1 0",
                "V2 vdd 0 DC 5.0",
                "R1 vdd out 10k",
                "R2 out g 10k",
                "Cin in g 1u",
                ".SAVE VR(out) VI(out)",
                ".AC dec 5 10 10g"
            );
            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS1_Transient()
        {
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000505416909166e-06, 1.000916250727498e-06, 1.001000000000000e-06, 1.001040727433434e-06, 1.001122182300302e-06, 1.001285092034037e-06, 1.001610911501508e-06, 1.002262550436450e-06, 1.003565828306334e-06, 1.006172384046101e-06, 1.011385495525637e-06, 1.021811718484707e-06, 1.042664164402849e-06, 1.084369056239132e-06, 1.167778839911697e-06, 1.334598407256829e-06, 1.534598407256829e-06, 1.734598407256829e-06, 1.934598407256829e-06, 2.134598407256829e-06, 2.334598407256828e-06, 2.534598407256828e-06, 2.734598407256828e-06, 2.934598407256828e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.234987431524396e-06, 3.325439370636818e-06, 3.420856173579676e-06, 3.501000000000000e-06, 3.511070126950724e-06, 3.531210380852173e-06, 3.571490888655072e-06, 3.652051904260868e-06, 3.813173935472461e-06, 4.013173935472461e-06, 4.213173935472461e-06, 4.413173935472461e-06, 4.613173935472461e-06, 4.813173935472461e-06, 5.013173935472460e-06, 5.213173935472460e-06, 5.413173935472460e-06, 5.613173935472460e-06, 5.813173935472459e-06, 6.013173935472459e-06, 6.213173935472459e-06, 6.413173935472459e-06, 6.613173935472459e-06, 6.813173935472458e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000505416909549e-06, 7.000916250728646e-06, 7.001000000000000e-06, 7.001040727433112e-06, 7.001122182299336e-06, 7.001285092031785e-06, 7.001610911496682e-06, 7.002262550426477e-06, 7.003565828286065e-06, 7.006172384005243e-06, 7.011385495443598e-06, 7.021811718320309e-06, 7.042664164073730e-06, 7.084369055580572e-06, 7.167778838594256e-06, 7.334598404621625e-06, 7.534598404621625e-06, 7.734598404621625e-06, 7.934598404621625e-06, 8.134598404621625e-06, 8.334598404621624e-06, 8.534598404621624e-06, 8.734598404621624e-06, 8.934598404621624e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.234987431524394e-06, 9.325439370636817e-06, 9.420856173579676e-06, 9.500999999999999e-06, 9.511070126950724e-06, 9.531210380852173e-06, 9.571490888655071e-06, 9.652051904260868e-06, 9.813173935472463e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 4.999999995000000e+00, 5.003960391035683e+00, 5.004038814719480e+00, 5.003961923904321e+00, 5.819690929283165e-04, 4.809512662039081e-04, 4.816080793679862e-04, 4.816080824723305e-04, 4.816080793679972e-04, 4.816080824751206e-04, 4.816080793680001e-04, 4.816080824751195e-04, 4.816080793680010e-04, 4.816080824751188e-04, 4.816080793680010e-04, 4.816080824751190e-04, 4.816080793680009e-04, 4.816080824751187e-04, 4.816080793680011e-04, 4.816080824751188e-04, 4.816080793680012e-04, 4.816080824751188e-04, 4.816080793680012e-04, 4.816080824751188e-04, 4.816080793680012e-04, 4.816080824751188e-04, 4.816080793680012e-04, 4.816080824751189e-04, 5.243402547937085e-04, 6.374703407534488e-04, 1.121494264302770e-03, -1.720170200560766e+01, 4.999968188570249e+00, 5.000015800431791e+00, 4.999968190756332e+00, 4.999999991842038e+00, 4.999999998157336e+00, 4.999999991842977e+00, 4.999999998156865e+00, 4.999999991843213e+00, 4.999999998156724e+00, 4.999999991843340e+00, 4.999999998156598e+00, 4.999999991843466e+00, 4.999999998156472e+00, 4.999999991843592e+00, 4.999999998156345e+00, 4.999999991843718e+00, 4.999999998156220e+00, 4.999999991843845e+00, 4.999999998156093e+00, 4.999999991843971e+00, 4.999999998155968e+00, 4.999999991844097e+00, 4.999999998155841e+00, 4.999999991844228e+00, 5.003960391004448e+00, 5.004038814750084e+00, 5.003961923874312e+00, 5.819690912929626e-04, 4.809512662030679e-04, 4.816080793679895e-04, 4.816080824723272e-04, 4.816080793680006e-04, 4.816080824751174e-04, 4.816080793680036e-04, 4.816080824751161e-04, 4.816080793680041e-04, 4.816080824751155e-04, 4.816080793680043e-04, 4.816080824751158e-04, 4.816080793680044e-04, 4.816080824751156e-04, 4.816080793680043e-04, 4.816080824751156e-04, 4.816080793680043e-04, 4.816080824751154e-04, 4.816080793680043e-04, 4.816080824751154e-04, 4.816080793680043e-04, 4.816080824751154e-04, 4.816080793680043e-04, 4.816080824751156e-04, 5.243402547937047e-04, 6.374703407534429e-04, 1.121494264302742e-03, -1.720170200561765e+01, 4.999968188570249e+00, 5.000015800431791e+00, 4.999968190756332e+00, 4.999999991842038e+00, 4.999999998157336e+00, 4.999999991842977e+00, 4.999999998156865e+00, 4.999999991843213e+00, 4.999999998156719e+00
            };

            // Parse the netlist
            var netlist = Run(
                "M1 out in 0 0 MM L = 100u W = 100u",
                ".MODEL MM NMOS LEVEL = 1 IS = 1e-32 VTO = 3.03646 LAMBDA = 0 KP = 5.28747 CGSO = 6.5761e-06 CGDO = 1e-11",
                "V1 in 0 PULSE(1 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 5",
                "R1 out vdd 1k",
                ".SAVE V(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }
    }
}
