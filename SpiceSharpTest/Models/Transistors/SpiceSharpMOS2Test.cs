using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace SpiceSharpTest.Models.Transistors
{
    /// <summary>
    /// Taken from https://ecee.colorado.edu/~bart/book/book/chapter7/ch7_5.htm
    /// .MODEL NFET NMOS (LEVEL=2 L=1u W=1u VTO=-1.44 KP=8.64E-6 NSUB = 1E17 TOX = 20n)
    /// </summary>
    [TestClass]
    public class SpiceSharpMOS2Test : Framework
    {
        [TestMethod]
        public void TestMOS2_DC()
        {
            // Reference as simulated by SmartSpice
            // GMIN = 1e-12
            // vds,vgs: 0->5V in 0.5V steps
            double[] reference = new double[]
            {
                0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -5.306938374762972e-07, -6.622829041640560e-07, -7.937581773977502e-07, -9.251785148533939e-07, -1.056441430021354e-06, -1.187609694370174e-06, -1.318690166921324e-06, -1.449689582954881e-06, -1.580614434647696e-06, -1.711470885280740e-06, -1.842234231506578e-06, -1.973001281184612e-06, -8.638458189766005e-07, -1.127266444634827e-06, -1.390443306657313e-06, -1.653501971091858e-06, -1.916220385611531e-06, -2.178732520029357e-06, -2.441052620744218e-06, -2.703194944444612e-06, -2.965173447617107e-06, -3.227001546857695e-06, -3.488624957291339e-06, -3.750256530772285e-06, -1.006642980508283e-06, -1.402162238528042e-06, -1.797292612754292e-06, -2.192233497165614e-06, -2.586626029833044e-06, -2.980682817909460e-06, -3.374425544258125e-06, -3.767876414662800e-06, -4.161057587020059e-06, -4.553990700396846e-06, -4.946585972966656e-06, -5.339194629813526e-06, -1.013799629686942e-06, -1.492058405858433e-06, -2.019403706665254e-06, -2.546496484060867e-06, -3.072809142672583e-06, -3.598638739462067e-06, -4.124013782720594e-06, -4.648964295325035e-06, -5.173520940461242e-06, -5.697714250780706e-06, -6.221411805023045e-06, -6.745128648886488e-06, -1.014566859581403e-06, -1.493160556051296e-06, -2.066690337648868e-06, -2.719762043312447e-06, -3.378613416700301e-06, -4.036472154916655e-06, -4.693717658953345e-06, -5.350386898042717e-06, -6.006518700031038e-06, -6.662152648009599e-06, -7.317105161899917e-06, -7.972083359353302e-06, -1.015356741659893e-06, -1.494299909660686e-06, -2.068236078452062e-06, -2.740840251690813e-06, -3.506586652651430e-06, -4.297180144702505e-06, -5.086563054272630e-06, -5.875199503675225e-06, -6.663135327029221e-06, -7.450418581483120e-06, -8.236804578683890e-06, -9.023222801083452e-06, -1.016165437476091e-06, -1.495471083771302e-06, -2.069831356580057e-06, -2.742900593322288e-06, -3.513262901776043e-06, -4.382683065140698e-06, -5.301923036398998e-06, -6.225832546756225e-06, -7.145831520790295e-06, -8.065003070358788e-06, -8.983030137568078e-06, -9.901095627549166e-06, -1.016989023485014e-06, -1.496668363213843e-06, -2.071468364563983e-06, -2.745024194610477e-06, -3.515924552362666e-06, -4.385920816155342e-06, -5.355855832487864e-06, -6.403691255248455e-06, -7.456598730009609e-06, -8.507928636677179e-06, -9.557835816840147e-06, -1.060778666199651e-05, -1.017823668891155e-06, -1.497885983840097e-06, -2.073138975424704e-06, -2.747200785959000e-06, -3.518664091102590e-06, -4.389267691949250e-06, -5.359844436218669e-06, -6.431152584792028e-06, -7.596428673614574e-06, -8.780851152468184e-06, -9.962909998812256e-06, -1.114501614174265e-05, -1.018665778845741e-06, -1.499118382335761e-06, -2.074835139260058e-06, -2.749419763651192e-06, -3.521468187712419e-06, -4.392707866929063e-06, -5.363962030875167e-06, -6.435978121313036e-06, -7.609441818854552e-06, -8.884419035140827e-06, -1.019964577331805e-05, -1.151420833828413e-05, -1.019512094513571e-06, -1.500360390171152e-06, -2.076549213836832e-06, -2.751670684538682e-06, -3.524323247900116e-06, -4.396224548237776e-06, -5.368188911914150e-06, -6.440953329762988e-06, -7.615191814315274e-06, -8.891527316636293e-06, -1.027054150786247e-05, -1.171578914356212e-05
            };

            var netlist = Run(
                "M1 out in 0 0 NFET L = 6u W = 1u",
                ".MODEL NFET NMOS(LEVEL = 2 L = 1u W = 1u VTO = -1.44 KP = 8.64E-6 NSUB = 1E17 TOX = 20n)",
                "V1 in 0 0",
                "V2 out 0 0",
                ".SAVE I(V2)",
                ".DC V1 0 3.3 0.3 V2 0 3.3 0.3"
                );
            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS2_AC()
        {
            // Simulation by Spice 3f5
            double[] reference = new double[]
            {
                2.701114568959397e-01, 2.297592026993491e-01, 3.614367501477384e-01, 1.939823511070750e-01, 4.176532699259306e-01, 1.414313855763639e-01, 4.452214249772693e-01, 9.512747415960789e-02, 4.572366767698547e-01, 6.164118367404970e-02, 4.622024752123699e-01, 3.931535278467341e-02, 4.642095432402752e-01, 2.491402951340239e-02, 4.650134308270042e-01, 1.574691222820917e-02, 4.653342396231024e-01, 9.942484429536930e-03, 4.654620791267926e-01, 6.275007008504113e-03, 4.655129925001772e-01, 3.959694832353351e-03, 4.655332645790356e-01, 2.498507336198679e-03, 4.655413355303657e-01, 1.576478884956591e-03, 4.655445487118463e-01, 9.946977962705516e-04, 4.655458279147781e-01, 6.276136046196179e-04, 4.655463371765942e-01, 3.959978465130569e-04, 4.655465399176849e-01, 2.498578584664746e-04, 4.655466206304160e-01, 1.576496782075489e-04, 4.655466527627409e-01, 9.947022918549027e-05, 4.655466655548509e-01, 6.276147338624847e-05, 4.655466706474820e-01, 3.959981301663537e-05, 4.655466726748949e-01, 2.498579297169927e-05, 4.655466734820225e-01, 1.576496961048729e-05, 4.655466738033459e-01, 9.947023368109509e-06, 4.655466739312669e-01, 6.276147451549338e-06, 4.655466739821933e-01, 3.959981330028886e-06, 4.655466740024674e-01, 2.498579304294980e-06, 4.655466740105386e-01, 1.576496962838461e-06, 4.655466740137518e-01, 9.947023372605108e-07, 4.655466740150311e-01, 6.276147452678582e-07, 4.655466740155403e-01, 3.959981330312538e-07, 4.655466740157432e-01, 2.498579304366230e-07, 4.655466740158237e-01, 1.576496962856358e-07, 4.655466740158559e-01, 9.947023372650060e-08, 4.655466740158686e-01, 6.276147452689869e-08, 4.655466740158738e-01, 3.959981330315371e-08, 4.655466740158758e-01, 2.498579304366941e-08, 4.655466740158766e-01, 1.576496962856536e-08, 4.655466740158769e-01, 9.947023372650503e-09, 4.655466740158770e-01, 6.276147452689979e-09, 4.655466740158772e-01, 3.959981330315399e-09, 4.655466740158772e-01, 2.498579304366946e-09, 4.655466740158771e-01, 1.576496962856537e-09, 4.655466740158772e-01, 9.947023372650507e-10, 4.655466740158772e-01, 6.276147452689978e-10, 4.655466740158771e-01, 3.959981330315396e-10
            };

            var netlist = Run(
                "M1 out g 0 0 NFET L = 6u W = 1u",
                ".MODEL NFET NMOS(LEVEL = 2 L = 1u W = 1u VTO = -1.44 KP = 8.64E-6 NSUB = 1E17 TOX = 20n)",
                "V1 in 0 DC 0 AC 1 0",
                "V2 vdd 0 DC 5.0",
                "R1 vdd out 10k",
                "R2 out g 10k",
                "Cin in g 1u",
                ".SAVE VR(out) VI(out)",
                ".AC dec 5 10 10g"
                );
            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS2_Transient()
        {
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000125000000000e-06, 1.000175000000000e-06, 1.000275000000000e-06, 1.000278125000000e-06, 1.000284375000000e-06, 1.000296875000000e-06, 1.000300000000000e-06, 1.000306250000000e-06, 1.000318750000000e-06, 1.000343750000000e-06, 1.000393750000000e-06, 1.000493750000000e-06, 1.000693750000000e-06, 1.001000000000000e-06, 1.001040000000000e-06, 1.001120000000000e-06, 1.001280000000000e-06, 1.001600000000000e-06, 1.002040869709307e-06, 1.002630387378758e-06, 1.003503895486650e-06, 1.005250911702435e-06, 1.008744944134003e-06, 1.015733008997139e-06, 1.029709138723412e-06, 1.057661398175958e-06, 1.113565917081049e-06, 1.225374954891232e-06, 1.425374954891232e-06, 1.625374954891232e-06, 1.825374954891232e-06, 2.025374954891232e-06, 2.225374954891231e-06, 2.425374954891231e-06, 2.625374954891231e-06, 2.825374954891231e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.301000000000000e-06, 3.501000000000000e-06, 3.520999999999999e-06, 3.560999999999999e-06, 3.641000000000000e-06, 3.801000000000000e-06, 4.000999999999999e-06, 4.200999999999999e-06, 4.400999999999999e-06, 4.600999999999999e-06, 4.800999999999999e-06, 5.000999999999998e-06, 5.200999999999998e-06, 5.400999999999998e-06, 5.600999999999998e-06, 5.800999999999997e-06, 6.000999999999997e-06, 6.200999999999997e-06, 6.400999999999997e-06, 6.600999999999997e-06, 6.800999999999996e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000125000000000e-06, 7.000175000000000e-06, 7.000275000000000e-06, 7.000278125000001e-06, 7.000284375000000e-06, 7.000296875000000e-06, 7.000300000000001e-06, 7.000306250000000e-06, 7.000318750000000e-06, 7.000343750000000e-06, 7.000393750000000e-06, 7.000493750000001e-06, 7.000693750000000e-06, 7.001000000000000e-06, 7.001040000000000e-06, 7.001119999999999e-06, 7.001280000000000e-06, 7.001599999999999e-06, 7.002040869709306e-06, 7.002630387378757e-06, 7.003503895486649e-06, 7.005250911702431e-06, 7.008744944133995e-06, 7.015733008997125e-06, 7.029709138723382e-06, 7.057661398175898e-06, 7.113565917080928e-06, 7.225374954890990e-06, 7.425374954890989e-06, 7.625374954890989e-06, 7.825374954890989e-06, 8.025374954890989e-06, 8.225374954890988e-06, 8.425374954890988e-06, 8.625374954890988e-06, 8.825374954890988e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.300999999999998e-06, 9.500999999999998e-06, 9.520999999999997e-06, 9.560999999999997e-06, 9.640999999999996e-06, 9.800999999999996e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 2.890995886147282e+00, 2.860889857132761e+00, 2.797358759913337e+00, 2.656952631372152e+00, 2.652277009221235e+00, 2.642908255132196e+00, 2.623995709740195e+00, 2.625963123246012e+00, 2.635570803068064e+00, 2.649551412109248e+00, 2.676792196267952e+00, 2.727134399322510e+00, 2.807235874687377e+00, 2.895226358746865e+00, 2.890643107153419e+00, 2.747529451643542e+00, 2.511671172027926e+00, 2.222703989928791e+00, 1.980904508221184e+00, 1.907035081340556e+00, 1.897814593768682e+00, 1.898216725792973e+00, 1.898102475691170e+00, 1.898170304322125e+00, 1.898117262505580e+00, 1.898164305228169e+00, 1.898119974048493e+00, 1.898163015262515e+00, 1.898120603337809e+00, 1.898162692330543e+00, 1.898120833175728e+00, 1.898162463752065e+00, 1.898121060509544e+00, 1.898162237663149e+00, 1.898121285367317e+00, 1.898162014036679e+00, 1.898121507776016e+00, 1.898161777585801e+00, 1.924031814482526e+00, 1.985320879606215e+00, 2.121598576848245e+00, 2.474983797644688e+00, 3.000536620117643e+00, 3.000419418896685e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 2.890995886147031e+00, 2.860889857132500e+00, 2.797358759913059e+00, 2.656952631371520e+00, 2.652277009220283e+00, 2.642908255131871e+00, 2.623995709739870e+00, 2.625963123246294e+00, 2.635570803067293e+00, 2.649551412109180e+00, 2.676792196268035e+00, 2.727134399323084e+00, 2.807235874688100e+00, 2.895226358746244e+00, 2.890643107153657e+00, 2.747529451644962e+00, 2.511671172028991e+00, 2.222703989929422e+00, 1.980904508221402e+00, 1.907035081340612e+00, 1.897814593768682e+00, 1.898216725792973e+00, 1.898102475691170e+00, 1.898170304322125e+00, 1.898117262505580e+00, 1.898164305228169e+00, 1.898119974048493e+00, 1.898163015262515e+00, 1.898120603337809e+00, 1.898162692330543e+00, 1.898120833175727e+00, 1.898162463752065e+00, 1.898121060509544e+00, 1.898162237663149e+00, 1.898121285367317e+00, 1.898162014036679e+00, 1.898121507776016e+00, 1.898161777585801e+00, 1.924031814482524e+00, 1.985320879606211e+00, 2.121598576848240e+00, 2.474983797644681e+00, 3.000536620117638e+00, 3.000419418896685e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00, 3.000419418896398e+00
            };

            // Parse the netlist
            var netlist = Run(
                "M1 out in 0 0 NFET L = 6u W = 1u",
                ".MODEL NFET NMOS (LEVEL=2 L=1u W=1u VTO=-1.44 KP=8.64E-6 NSUB = 1E17 TOX = 20n)",
                "V1 in 0 PULSE(1 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 3.3",
                "R1 out vdd 100k",
                ".SAVE V(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }
    }
}
