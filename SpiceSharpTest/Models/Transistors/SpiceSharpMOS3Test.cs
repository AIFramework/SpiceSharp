using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace SpiceSharpTest.Models.Transistors
{
    /// <summary>
    /// Model part of the FDC604P (ONSemi)
    /// M1 2 1 4x 4x DMOS L = 1u W = 1u
    /// .MODEL DMOS PMOS(VTO= -0.7 KP= 3.8E+1 THETA = .25 VMAX= 3.5E5 LEVEL= 3)
    /// </summary>
    [TestClass]
    public class SpiceSharpMOS3Test : Framework
    {
        [TestMethod]
        public void TestMOS3_DC()
        {
            // Simulation by Spice 3f5
            double[] reference = new double[]
            {
                -1.262177448353619e-29, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -4.159905034473416e-13, -4.159905034473416e-13, -4.159905034473416e-13, -7.010973787728751e-01, -3.391621129326464e+00, -5.921232876712748e+00, -8.164781906300902e+00, -8.319810068946831e-13, -8.319810068946831e-13, -8.319810068946831e-13, -7.010973787732908e-01, -3.928205688972319e+00, -8.750000000000831e+00, -1.323794712286243e+01, -1.247971510342025e-12, -1.247971510342025e-12, -1.247971510342025e-12, -7.010973787737074e-01, -3.928205688972735e+00, -9.117778872755419e+00, -1.555322338830710e+01, -1.663962013789366e-12, -1.663962013789366e-12, -1.663962013789366e-12, -7.010973787741221e-01, -3.928205688973152e+00, -9.117778872755839e+00, -1.577264391107695e+01, -2.079952517236708e-12, -2.079952517236708e-12, -2.079952517236708e-12, -7.010973787745387e-01, -3.928205688973566e+00, -9.117778872756254e+00, -1.577264391107736e+01, -2.495943020684050e-12, -2.495943020684050e-12, -2.495943020684050e-12, -7.010973787749553e-01, -3.928205688973984e+00, -9.117778872756670e+00, -1.577264391107778e+01
            };

            var netlist = Run(
                "M1 d g 0 0 DMOS L = 1u W = 1u",
                ".MODEL DMOS pmos(LEVEL = 3 VTO = -0.7 KP = 3.8E+1 THETA = .25 VMAX = 3.5E5)",
                "V1 0 g 0",
                "V2 0 d 0",
                ".SAVE I(V2)",
                ".DC V1 0 1.8 0.3 V2 0 1.8 0.3"
                );
            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS3_AC()
        {
            // Simulation by Spice 3f5
            double[] reference = new double[]
            {
                -1.158810599041031e-03, -6.264666308983062e-01, -2.910785562780048e-03, -9.928775624090392e-01, -7.311467754617840e-03, -1.573584442377611e+00, -1.836497723001838e-02, -2.493881872305273e+00, -4.612695548552383e-02, -3.952212387360880e+00, -1.158418199841906e-01, -6.262544952788643e+00, -2.908310983699995e-01, -9.920334761677134e+00, -7.295874663559818e-01, -1.570228475242013e+01, -1.826691407506066e+00, -2.480565333905739e+01, -4.551327382031449e+00, -3.899631412665991e+01, -1.120476362942743e+01, -6.057426922698291e+01, -2.680436040392859e+01, -9.143046591988683e+01, -6.013402567069348e+01, -1.294213014796850e+02, -1.190827358604176e+02, -1.617090359259407e+02, -1.953008393612502e+02, -1.673360811397467e+02, -2.620804660293222e+02, -1.416837805190232e+02, -3.033779825926325e+02, -1.034831269251784e+02, -3.236832897330351e+02, -6.966357591604135e+01, -3.325441275376594e+02, -4.515800705988195e+01, -3.362081893825310e+02, -2.880671739167397e+01, -3.376894483860671e+02, -1.825588851149574e+01, -3.382827870034562e+02, -1.153892589202413e+01, -3.385195800352252e+02, -7.285666332142296e+00, -3.386139413216285e+02, -4.598226065815844e+00, -3.386515218681043e+02, -2.901606502397011e+00, -3.386664852746954e+02, -1.830870827413761e+00, -3.386724426821622e+02, -1.155221716244265e+00, -3.386748144271218e+02, -7.289007308704162e-01, -3.386757586450418e+02, -4.599065517454275e-01, -3.386761345464316e+02, -2.901817386751174e-01, -3.386762841957024e+02, -1.830923801532522e-01, -3.386763437721871e+02, -1.155235022977691e-01, -3.386763674900185e+02, -7.289040733943720e-02, -3.386763769322583e+02, -4.599073913518486e-02, -3.386763806912818e+02, -2.901819495749514e-02, -3.386763821877761e+02, -1.830924331289191e-02, -3.386763827835411e+02, -1.155235156046573e-02, -3.386763830207194e+02, -7.289041068197660e-03, -3.386763831151419e+02, -4.599073997479281e-03, -3.386763831527321e+02, -2.901819516839512e-03, -3.386763831676970e+02, -1.830924336586758e-03, -3.386763831736548e+02, -1.155235157377262e-03, -3.386763831760265e+02, -7.289041071540198e-04, -3.386763831769707e+02, -4.599073998318887e-04, -3.386763831773466e+02, -2.901819517050410e-04, -3.386763831774963e+02, -1.830924336639732e-04
            };

            var netlist = Run(
                "M1 out g vdd vdd DMOS L = 1u W = 1u",
                ".MODEL DMOS pmos(LEVEL = 3 VTO = -0.7 KP = 3.8E+1 THETA = .25 VMAX = 3.5E5)",
                "Vsupply vdd 0 1.8",
                "Vin in 0 DC 0 AC 1 0",
                "R1 out 0 100k",
                "R2 g out 10k",
                "Cin in g 1u",
                ".SAVE VR(out) VI(out)",
                ".AC dec 5 10 10g"
                );
            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestMOS3_Transient()
        {
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000700000000000e-06, 1.001000000000000e-06, 1.001080000000000e-06, 1.001240000000000e-06, 1.001560000000000e-06, 1.002200000000000e-06, 1.003480000000000e-06, 1.006040000000000e-06, 1.011160000000001e-06, 1.021400000000002e-06, 1.041880000000003e-06, 1.082840000000006e-06, 1.164760000000012e-06, 1.328600000000025e-06, 1.528600000000025e-06, 1.728600000000025e-06, 1.928600000000025e-06, 2.128600000000025e-06, 2.328600000000025e-06, 2.528600000000024e-06, 2.728600000000024e-06, 2.928600000000024e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.301000000000000e-06, 3.501000000000000e-06, 3.520999999999999e-06, 3.560999999999999e-06, 3.641000000000000e-06, 3.801000000000000e-06, 4.000999999999999e-06, 4.200999999999999e-06, 4.400999999999999e-06, 4.600999999999999e-06, 4.800999999999999e-06, 5.000999999999998e-06, 5.200999999999998e-06, 5.400999999999998e-06, 5.600999999999998e-06, 5.800999999999997e-06, 6.000999999999997e-06, 6.200999999999997e-06, 6.400999999999997e-06, 6.600999999999997e-06, 6.800999999999996e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000700000000000e-06, 7.001000000000000e-06, 7.001079999999999e-06, 7.001239999999999e-06, 7.001559999999999e-06, 7.002199999999999e-06, 7.003479999999999e-06, 7.006039999999998e-06, 7.011159999999996e-06, 7.021399999999993e-06, 7.041879999999985e-06, 7.082839999999971e-06, 7.164759999999943e-06, 7.328599999999885e-06, 7.528599999999885e-06, 7.728599999999886e-06, 7.928599999999885e-06, 8.128599999999885e-06, 8.328599999999885e-06, 8.528599999999885e-06, 8.728599999999885e-06, 8.928599999999884e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.300999999999998e-06, 9.500999999999998e-06, 9.520999999999997e-06, 9.560999999999997e-06, 9.640999999999996e-06, 9.800999999999996e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                1.799999451299451e+00, 1.799999453635131e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999450956926e+00, 1.799999450956929e+00, 1.799999389971110e+00, 1.799999183568271e+00, 7.448095922434256e-02, -7.448046003580762e-02, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 1.799998636447238e+00, 1.800000994575628e+00, 1.799999453635142e+00, 1.799999453635142e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999389971109e+00, 1.799999183568270e+00, 7.448095922456173e-02, -7.448046003602679e-02, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 2.495942674587899e-07, 1.799998636447239e+00, 1.800000994575627e+00, 1.799999453635142e+00, 1.799999453635142e+00, 1.799999450956928e+00, 1.799999450956927e+00, 1.799999450956928e+00
            };

            var netlist = Run(
                "M1 out in vdd vdd DMOS L = 1u W = 1u",
                ".MODEL DMOS pmos(LEVEL = 3 VTO = -0.7 KP = 3.8E+1 THETA = .25 VMAX = 3.5E5)",
                "V1 in 0 PULSE(0 1.8 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 1.8",
                "R1 out 0 100k",
                ".SAVE V(out)",
                ".tran 1n 10u"
            );
            TestTransient(netlist, reft, refv);
        }
    }
}
