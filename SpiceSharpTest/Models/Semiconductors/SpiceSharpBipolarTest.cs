using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SpiceSharp.Simulations;

namespace SpiceSharpTest.Models
{
    /// <summary>
    /// BJT MJD44H11 (ON Semiconductors)
    /// </summary>
    [TestClass]
    public class SpiceSharpBipolarTest : Framework
    {
        [TestMethod]
        public void TestBJT_DC()
        {
            // Provided by Spice 3f5
            double[] reference = new double[]
            {
                -6.097599869520956e-37, -7.656097977815080e-13, -1.374900193695794e-12, -2.039257651631488e-12, -2.742694960033987e-12, -3.524291969370097e-12, -4.320099833421409e-12, -5.186961971048731e-12, -6.096456672821660e-12, -7.077005648170598e-12, -8.100187187665142e-12, 8.841977827306400e-12, -2.163602630389505e-12, -2.838618229361600e-12, -3.559819106158102e-12, -4.341416115494212e-12, -5.172751116333529e-12, -6.053824108676054e-12, -6.977529665164184e-12, -7.958078640513122e-12, -8.981260180007666e-12, -1.003286342893261e-11, 4.376458554330768e-10, -1.342783662039437e-10, -1.413802408478659e-10, -1.485318534832913e-10, -1.557296513965412e-10, -1.629842927286518e-10, -1.702744611975504e-10, -1.776072622305946e-10, -1.849969066824997e-10, -1.924576054079807e-10, -1.999467258428922e-10, 2.168331802615873e-08, -1.248734982084443e-08, -1.310184316594132e-08, -1.371638091995919e-08, -1.433097907010961e-08, -1.494561274739681e-08, -1.556030326810287e-08, -1.617502221051836e-08, -1.678982641806215e-08, -1.740465904731536e-08, -1.801953430913272e-08, 1.118392232919437e-06, -1.167279563674128e-06, -1.225296003326548e-06, -1.283312485611532e-06, -1.341329031845362e-06, -1.399345634922611e-06, -1.457362245105287e-06, -1.515378954763946e-06, -1.573395692844315e-06, -1.631412473557248e-06, -1.689429325324454e-06, 6.188771226659289e-05, -1.090991015075815e-04, -1.145814656631217e-04, -1.200638293852307e-04, -1.255461928977297e-04, -1.310285561686442e-04, -1.365109192050795e-04, -1.419932820567738e-04, -1.474756446668835e-04, -1.529580070638303e-04, -1.584403691765601e-04, 3.275398651073885e-03, -1.012844747663877e-02, -1.064307370146267e-02, -1.115769751705642e-02, -1.167231893956000e-02, -1.218693796899117e-02, -1.270155460535705e-02, -1.321616884872867e-02, -1.373078069903499e-02, -1.424539015641813e-02, -1.475999722086385e-02, 4.151238565042040e-02, -6.251622455931329e-01, -6.571964167557454e-01, -6.892240016470339e-01, -7.212450230668637e-01, -7.532594837398392e-01, -7.852673863879005e-01, -8.172687337325613e-01, -8.492635284927701e-01, -8.812517733859551e-01, -9.132334711280237e-01, 9.947058738595213e-02, -4.309497632319092e+00, -4.531107647603950e+00, -4.752561385490615e+00, -4.973908096406554e+00, -5.195147864142122e+00, -5.416280772366491e+00, -5.637306904689041e+00, -5.858226344618870e+00, -6.079039175577975e+00, -6.299745480900796e+00
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 b 0 0",
                "V2 c 0 0",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE I(V2)",
                ".DC V2 0 5 0.5 V1 0 0.8 0.1"
                );

            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_AC()
        {
            // Provided by Spice 3f5
            double[] reference = new double[]
            {
                1.334417655221980e-06, 3.471965089573855e-04, 3.351830745696013e-06, 5.502570946227631e-04, 8.418945895773091e-06, 8.720498043349111e-04, 2.114445669597715e-05, 1.381911086546095e-03, 5.309368526798767e-05, 2.189406695272188e-03, 1.332469066652801e-04, 3.466895147088519e-03, 3.339563613753495e-04, 5.482432501910041e-03, 8.341980040370838e-04, 8.640775529878610e-03, 2.066558898597437e-03, 1.350614394562201e-02, 5.017427448376647e-03, 2.069020111657962e-02, 1.162687214173938e-02, 3.025147596713823e-02, 2.444806066150139e-02, 4.013545957396424e-02, 4.357949902126838e-02, 4.514050832244691e-02, 6.329927287469508e-02, 4.136984589249247e-02, 7.720778968190564e-02, 3.183821694967992e-02, 8.460892410281323e-02, 2.201455496720316e-02, 8.796592758796802e-02, 1.444187547976473e-02, 8.937770311337524e-02, 9.259273400620100e-03, 8.995244044657573e-02, 5.881087349156822e-03, 9.018332766108907e-02, 3.722325696488075e-03, 9.027562051537530e-02, 2.354340724190597e-03, 9.031252808298670e-02, 1.491338054090599e-03, 9.032751174287086e-02, 9.494226860852419e-04, 9.033418279536445e-02, 6.121839678644537e-04, 9.033858322545095e-02, 4.068213923146900e-04, 9.034456220674272e-02, 2.884413123461115e-04, 9.035667499179965e-02, 2.293512095670835e-04, 9.038149464070862e-02, 2.102372862964324e-04, 9.042443030168182e-02, 2.125125991591695e-04, 9.048191631184550e-02, 2.196186992195977e-04, 9.054643271040638e-02, 2.275933681030558e-04, 9.062185343008870e-02, 2.359674744810244e-04, 9.071079692976204e-02, 2.293406880105504e-04, 9.079365040405128e-02, 1.944976240778601e-04, 9.084916360239494e-02, 1.441205567769841e-04, 9.087793546139711e-02, 9.797275248013266e-05, 9.089082649598125e-02, 6.381079386729474e-05, 9.089621923422750e-02, 4.078876004594978e-05, 9.089840984364975e-02, 2.587116901301576e-05, 9.089928903096886e-02, 1.635803306437017e-05, 9.089964017582838e-02, 1.033019503723023e-05, 9.089978014956064e-02, 6.520640901851122e-06, 9.089983590285976e-02, 4.115679165634583e-06, 9.089985810348902e-02, 2.598362267948757e-06, 9.089986694319312e-02, 1.641720674824462e-06, 9.089987046435227e-02, 1.039399501946900e-06
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 DC 0 AC 1 0",
                "Vsupply vdd 0 5",
                "R1 vdd out 1k",
                "R2 out b 10k",
                "Cin in b 1u",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE vr(out) vi(out)",
                ".AC dec 5 10 10g"
                );

            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_Transient()
        {
            // Provided by Spice 3f5
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000700000000000e-06, 1.001000000000000e-06, 1.001049696459649e-06, 1.001149089378946e-06, 1.001347875217541e-06, 1.001745446894730e-06, 1.002540590249109e-06, 1.004130876957867e-06, 1.007311450375384e-06, 1.013672597210416e-06, 1.026394890880480e-06, 1.051839478220609e-06, 1.102728652900866e-06, 1.204507002261380e-06, 1.404507002261380e-06, 1.604507002261380e-06, 1.795021507620927e-06, 1.948987772044304e-06, 2.108098225084346e-06, 2.308098225084346e-06, 2.508098225084346e-06, 2.708098225084346e-06, 2.908098225084346e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.301000000000000e-06, 3.501000000000000e-06, 3.520999999999999e-06, 3.560999999999999e-06, 3.641000000000000e-06, 3.801000000000000e-06, 3.979597211851009e-06, 4.179597211851009e-06, 4.379597211851009e-06, 4.579597211851008e-06, 4.779597211851008e-06, 4.979597211851008e-06, 5.179597211851008e-06, 5.379597211851008e-06, 5.579597211851007e-06, 5.779597211851007e-06, 5.979597211851007e-06, 6.179597211851007e-06, 6.379597211851006e-06, 6.579597211851006e-06, 6.779597211851006e-06, 6.979597211851006e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000700000000000e-06, 7.001000000000000e-06, 7.001079999999999e-06, 7.001239999999999e-06, 7.001559999999999e-06, 7.002199999999999e-06, 7.003479999999999e-06, 7.006039999999998e-06, 7.011159999999996e-06, 7.021399999999993e-06, 7.041879999999985e-06, 7.082839999999971e-06, 7.164759999999943e-06, 7.306401532289403e-06, 7.318478064788666e-06, 7.342631129787190e-06, 7.348669396036821e-06, 7.360745928536084e-06, 7.384898993534609e-06, 7.433205123531657e-06, 7.505409418762610e-06, 7.622219576778190e-06, 7.742999908167346e-06, 7.942999908167346e-06, 8.142999908167346e-06, 8.342999908167345e-06, 8.542999908167345e-06, 8.742999908167345e-06, 8.942999908167345e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.300999999999998e-06, 9.500999999999998e-06, 9.520999999999997e-06, 9.560999999999997e-06, 9.640999999999996e-06, 9.800999999999996e-06, 9.978974581437602e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                4.999999919200253e+00, 4.999999919200255e+00, 4.999999919200257e+00, 4.999999919200257e+00, 4.999999919200254e+00, 4.999999919200251e+00, 4.999999919200262e+00, 4.999999919200238e+00, 4.999999919200220e+00, 4.999999919200224e+00, 4.999999919200335e+00, 4.999999919200595e+00, 4.999999919201074e+00, 4.999999919202737e+00, 4.999999919203373e+00, 4.999999919202466e+00, 4.999999919207248e+00, 4.999999919222666e+00, 4.999999919232952e+00, 4.999999919232896e+00, 4.999999919235138e+00, 5.000124013676115e+00, 5.000449644809906e+00, 5.001329565318438e+00, 5.002151320354394e+00, 5.002257931176161e+00, 5.002438731291836e+00, 5.002759875531355e+00, 5.003418829389991e+00, 5.004723690521532e+00, 5.007338182277549e+00, 5.012537599355243e+00, 5.022833864367484e+00, 5.042977321100457e+00, 5.081660972930782e+00, 5.152805430785034e+00, 5.271930426977085e+00, 5.255969233790093e+00, 1.875650939569375e+00, 1.655355969898117e-02, 9.556001645042004e-03, 8.136865215011708e-03, 7.985073458079497e-03, 7.760697026044105e-03, 7.884292942568174e-03, 7.763762091848382e-03, 7.859907320935727e-03, 7.720277896160717e-03, 7.464282606678842e-03, 7.089168014480994e-03, 6.639501735707142e-03, 6.021765651313742e-03, 6.343367833551087e-03, 7.492840043739433e-03, 1.052252760058226e-02, 2.183237193525422e-02, 5.187427607511873e-02, 1.338910818080578e-01, 2.753801394927131e-01, 4.713404644673220e-01, 7.099545099881287e-01, 9.802100003954627e-01, 1.271747888325117e+00, 1.574996394733722e+00, 1.881296854823639e+00, 2.183106622462620e+00, 2.474132828487931e+00, 2.749485735372362e+00, 3.005687963303573e+00, 3.240642817300832e+00, 3.453443602155948e+00, 3.644179422326411e+00, 3.662379728630661e+00, 3.662585299879685e+00, 3.663067665174840e+00, 3.664213504222711e+00, 3.665186048081400e+00, 3.665384419629818e+00, 3.665735315883072e+00, 3.666393122465745e+00, 3.667732679629078e+00, 3.670388991781171e+00, 3.675704186208955e+00, 3.686259923316456e+00, 3.707143038698101e+00, 3.747805332266094e+00, 3.816658429812950e+00, 3.571192303781204e+00, 1.137858494360595e+00, 9.014974815925411e-01, 5.114305820488912e-01, 4.317898940451413e-01, 2.895774711694458e-01, 7.882069192196429e-02, 1.607326694465361e-02, 1.218034787825219e-02, 8.940366671765431e-03, 8.465585229265897e-03, 7.810871038135640e-03, 7.933615066752445e-03, 7.741381854576213e-03, 7.888625655433749e-03, 7.757790710421915e-03, 7.870810757550325e-03, 7.786220710230148e-03, 7.700705127091174e-03, 7.472902842620830e-03, 7.081273182694703e-03, 6.648604047247847e-03, 6.001304047293490e-03, 6.333870834796702e-03, 7.494760135351435e-03, 1.052175678400317e-02, 2.183507140759269e-02, 5.169211273504988e-02, 5.736720851978777e-02
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 PULSE(0 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 5",
                "R1 vdd out 10k",
                "R2 in b 1k",
                "Q1 out b 0 0 mjd44h11",
                ".SAVE v(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }

        [TestMethod]
        public void TestBJT_Noise()
        {
            // Provided by Spice 3f5
            double[] reference_in = new double[]
            {
                9.782223714427987e-05, 4.902727264832426e-05, 2.457185338962746e-05, 1.231510568597593e-05, 6.172177827238539e-06, 3.093419303221456e-06, 1.550383886524483e-06, 7.770336358384338e-07, 3.894399852531180e-07, 1.951827573570842e-07, 9.782336428330867e-08, 4.902798449718650e-08, 2.457230320810896e-08, 1.231539017446422e-08, 6.172357999553372e-09, 3.093533656480485e-09, 1.550456710766847e-09, 7.770802570427241e-10, 3.894700734580881e-10, 1.952024139447066e-10, 9.783643896535056e-11, 4.903690627756174e-11, 2.457860468467670e-11, 1.232003835109984e-11, 6.175963014454194e-12, 3.096480480823246e-12, 1.552988244942930e-12, 7.793497608380497e-13, 3.915742472601946e-13, 1.972022715733277e-13, 9.977047753816183e-14, 5.092941583370216e-14, 2.644491120273891e-14, 1.416981186983834e-14, 8.015304915842651e-15, 4.929240476629539e-15, 3.381595339081205e-15, 2.605336551167759e-15, 2.215907737656946e-15, 2.020492600234610e-15, 1.922402615640859e-15, 1.873146263769304e-15, 1.848399728757252e-15, 1.835959299430869e-15, 1.829700476303181e-15, 1.826548592807994e-15, 1.824959418653644e-15, 1.824156956827553e-15, 1.823750995014642e-15, 1.823545148259813e-15, 1.823440476369602e-15, 1.823387067116046e-15, 1.823359700277232e-15, 1.823345606548012e-15, 1.823338304563228e-15, 1.823334494489318e-15, 1.823332490025238e-15, 1.823331425533426e-15, 1.823330854242250e-15, 1.823330544080329e-15, 1.823330373590984e-15, 1.823330278655256e-15, 1.823330225089411e-15, 1.823330194469076e-15, 1.823330176745610e-15, 1.823330166369695e-15, 1.823330160237792e-15, 1.823330156593352e-15, 1.823330154432723e-15, 1.823330153180771e-15, 1.823330152512752e-15, 1.823330152257153e-15, 1.823330152345095e-15, 1.823330152788673e-15, 1.823330153680120e-15, 1.823330155209951e-15, 1.823330157707057e-15, 1.823330161708856e-15, 1.823330168076021e-15, 1.823330178175495e-15, 1.823330194168774e-15, 1.823330219461373e-15, 1.823330259394320e-15, 1.823330322284795e-15, 1.823330420928892e-15, 1.823330574589480e-15, 1.823330811070094e-15, 1.823331167039915e-15, 1.823331680639254e-15, 1.823332361170861e-15, 1.823333113314647e-15
            };
            double[] reference_out = new double[]
            {
                1.179219862989481e-11, 9.366799509824981e-12, 7.440215819393452e-12, 5.909849953969606e-12, 4.694204355116928e-12, 3.728541470609732e-12, 2.961436248069141e-12, 2.352037572092826e-12, 1.867892810716822e-12, 1.483219628924207e-12, 1.177533053932103e-12, 9.345547120412678e-13, 7.413462160103590e-13, 5.876206817161517e-13, 4.651959586434446e-13, 3.675609264002581e-13, 2.895326170890468e-13, 2.269873731311376e-13, 1.766539773722950e-13, 1.359604399125598e-13, 1.029274183594503e-13, 7.609663023305161e-14, 5.446842860703937e-14, 3.740481097004802e-14, 2.446189680290874e-14, 1.518227588269855e-14, 8.959195761725242e-15, 5.059913505431299e-15, 2.760736675274261e-15, 1.470044930464820e-15, 7.716487852712253e-16, 4.034529515752228e-16, 2.127468258361768e-16, 1.151235562432188e-16, 6.553027189419247e-17, 4.046020619340668e-17, 2.782674437697462e-17, 2.147313449302714e-17, 1.828183346826315e-17, 1.668018849406525e-17, 1.587676549007375e-17, 1.547387872517497e-17, 1.527188688617226e-17, 1.517062892416029e-17, 1.511987266797110e-17, 1.509443203139195e-17, 1.508168078745598e-17, 1.507528979199142e-17, 1.507208662826275e-17, 1.507048121609172e-17, 1.506967659369265e-17, 1.506927332291652e-17, 1.506907120673515e-17, 1.506896990763351e-17, 1.506891913722307e-17, 1.506889369138883e-17, 1.506888093804600e-17, 1.506887454609958e-17, 1.506887134245389e-17, 1.506886973677496e-17, 1.506886893199605e-17, 1.506886852863024e-17, 1.506886832645527e-17, 1.506886822511944e-17, 1.506886817432599e-17, 1.506886814886564e-17, 1.506886813610314e-17, 1.506886812970543e-17, 1.506886812649814e-17, 1.506886812489016e-17, 1.506886812408394e-17, 1.506886812367966e-17, 1.506886812347690e-17, 1.506886812337520e-17, 1.506886812332418e-17, 1.506886812329857e-17, 1.506886812328572e-17, 1.506886812327926e-17, 1.506886812327602e-17, 1.506886812327438e-17, 1.506886812327356e-17, 1.506886812327315e-17, 1.506886812327294e-17, 1.506886812327284e-17, 1.506886812327278e-17, 1.506886812327275e-17, 1.506886812327274e-17, 1.506886812327273e-17, 1.506886812327273e-17, 1.506886812327273e-17, 1.506886812327273e-17
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 1 KF = 1e-8 AF = 1",
                "V1 in 0 DC 0 AC 1 0",
                "Vsupply vdd 0 5",
                "R1 vdd out 1k",
                "R2 out b 10k",
                "Cin in b 1u",
                "Q1 c b 0 0 mjd44h11",
                ".NOISE v(out) V1 dec 10 10 10g");
            TestNoise(netlist, reference_in, reference_out);
        }
    }
}
