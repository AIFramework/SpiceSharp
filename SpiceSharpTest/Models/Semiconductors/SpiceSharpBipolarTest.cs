using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SpiceSharp.Simulations;

namespace SpiceSharpTest.Models
{
    /// <summary>
    /// BJT MJD44H11 (ON Semiconductors)
    /// </summary>
    [TestClass]
    public class SpiceSharpBipolarTest : Framework
    {
        [TestMethod]
        public void TestBJT_DC()
        {
            double[] reference = new double[]
            {
                -6.097599869520956e-37, -7.656097977815080e-13, -1.556088591314619e-12, -2.117417352565099e-12, -2.785327524179593e-12, -3.538502824085299e-12, -4.362732397567015e-12, -5.201172825763933e-12, -6.110667527536862e-12, -7.048583938740194e-12, -8.100187187665142e-12, 8.841977827306400e-12, -2.163602630389505e-12, -3.065991904804832e-12, -3.645084234449314e-12, -4.384048679639818e-12, -5.186961971048731e-12, -6.053824108676054e-12, -6.991740519879386e-12, -7.958078640513122e-12, -8.981260180007666e-12, -1.006128513836302e-11, 4.376458554330768e-10, -1.342783662039437e-10, -1.416857742242428e-10, -1.486313294662978e-10, -1.557793893880444e-10, -1.629985035833670e-10, -1.702886720522656e-10, -1.776356839400250e-10, -1.850111175372149e-10, -1.924291836985503e-10, -1.999467258428922e-10, 2.168331802615867e-08, -1.248734982084443e-08, -1.310232278228796e-08, -1.371650881765163e-08, -1.433103591352847e-08, -1.494565537996095e-08, -1.556033168981230e-08, -1.617505063222779e-08, -1.678982641806215e-08, -1.740468746902479e-08, -1.801956273084215e-08, 1.118392232919441e-06, -1.167278709246489e-06, -1.225296056617253e-06, -1.283312641930934e-06, -1.341329095794208e-06, -1.399345663344320e-06, -1.457362287737851e-06, -1.515378940553092e-06, -1.573395707055170e-06, -1.631412473557248e-06, -1.689429296902745e-06, 6.188771226674805e-05, -1.090991015093579e-04, -1.145814695533431e-04, -1.200638297049750e-04, -1.255461931037871e-04, -1.310285563675961e-04, -1.365109193756098e-04, -1.419932821988823e-04, -1.474756447947811e-04, -1.529580072059389e-04, -1.584403693470904e-04, 3.275398650966012e-03, -1.012844747622310e-02, -1.064307519869701e-02, -1.115769871949368e-02, -1.167232013649766e-02, -1.218693916585778e-02, -1.270155580220944e-02, -1.321617004552422e-02, -1.373078189587318e-02, -1.424539135324210e-02, -1.475999841764519e-02, 4.151345410274419e-02, -6.252985299133353e-01, -6.572160484331135e-01, -6.892288999647604e-01, -7.212496869557441e-01, -7.532642014839865e-01, -7.852721632567068e-01, -8.172735697595357e-01, -8.492684236147454e-01, -8.812567275385561e-01, -9.132384842460510e-01, 9.945657384334780e-02, -4.310448312607067e+00, -4.534289357487243e+00, -4.753503929852833e+00, -4.974323324491031e+00, -5.195478565023656e+00, -5.416605381122110e+00, -5.637639257872564e+00, -5.858568864300622e+00, -6.079392270876383e+00, -6.300109206559384e+00
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 b 0 0",
                "V2 c 0 0",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE I(V2)",
                ".DC V2 0 5 0.5 V1 0 0.8 0.1"
                );

            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_AC()
        {
            double[] reference = new double[]
            {
                1.334417655221980e-06, 3.471965089573855e-04, 3.351830745696013e-06, 5.502570946227631e-04, 8.418945895773091e-06, 8.720498043349111e-04, 2.114445669597715e-05, 1.381911086546095e-03, 5.309368526798767e-05, 2.189406695272188e-03, 1.332469066652801e-04, 3.466895147088519e-03, 3.339563613753495e-04, 5.482432501910041e-03, 8.341980040370838e-04, 8.640775529878610e-03, 2.066558898597437e-03, 1.350614394562201e-02, 5.017427448376647e-03, 2.069020111657962e-02, 1.162687214173938e-02, 3.025147596713823e-02, 2.444806066150139e-02, 4.013545957396424e-02, 4.357949902126838e-02, 4.514050832244691e-02, 6.329927287469508e-02, 4.136984589249247e-02, 7.720778968190564e-02, 3.183821694967992e-02, 8.460892410281323e-02, 2.201455496720316e-02, 8.796592758796802e-02, 1.444187547976473e-02, 8.937770311337524e-02, 9.259273400620100e-03, 8.995244044657573e-02, 5.881087349156822e-03, 9.018332766108907e-02, 3.722325696488075e-03, 9.027562051537530e-02, 2.354340724190597e-03, 9.031252808298670e-02, 1.491338054090599e-03, 9.032751174287086e-02, 9.494226860852419e-04, 9.033418279536445e-02, 6.121839678644537e-04, 9.033858322545095e-02, 4.068213923146900e-04, 9.034456220674272e-02, 2.884413123461115e-04, 9.035667499179965e-02, 2.293512095670835e-04, 9.038149464070862e-02, 2.102372862964324e-04, 9.042443030168182e-02, 2.125125991591695e-04, 9.048191631184550e-02, 2.196186992195977e-04, 9.054643271040638e-02, 2.275933681030558e-04, 9.062185343008870e-02, 2.359674744810244e-04, 9.071079692976204e-02, 2.293406880105504e-04, 9.079365040405128e-02, 1.944976240778601e-04, 9.084916360239494e-02, 1.441205567769841e-04, 9.087793546139711e-02, 9.797275248013266e-05, 9.089082649598125e-02, 6.381079386729474e-05, 9.089621923422750e-02, 4.078876004594978e-05, 9.089840984364975e-02, 2.587116901301576e-05, 9.089928903096886e-02, 1.635803306437017e-05, 9.089964017582838e-02, 1.033019503723023e-05, 9.089978014956064e-02, 6.520640901851122e-06, 9.089983590285976e-02, 4.115679165634583e-06, 9.089985810348902e-02, 2.598362267948757e-06, 9.089986694319312e-02, 1.641720674824462e-06, 9.089987046435227e-02, 1.039399501946900e-06
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 DC 0 AC 1 0",
                "Vsupply vdd 0 5",
                "R1 vdd out 1k",
                "R2 out b 10k",
                "Cin in b 1u",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE vr(out) vi(out)",
                ".AC dec 5 10 10g"
                );

            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_Transient()
        {
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000700000000000e-06, 1.001000000000000e-06, 1.001049696459649e-06, 1.001149089378946e-06, 1.001347875217541e-06, 1.001745446894730e-06, 1.002540590249109e-06, 1.004130876957867e-06, 1.007311450375384e-06, 1.013672597210416e-06, 1.026394890880480e-06, 1.051839478220609e-06, 1.102728652900866e-06, 1.204507002261380e-06, 1.404507002261380e-06, 1.604507002261380e-06, 1.795021507620927e-06, 1.948987772044304e-06, 2.108098225084346e-06, 2.308098225084346e-06, 2.508098225084346e-06, 2.708098225084346e-06, 2.908098225084346e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.301000000000000e-06, 3.501000000000000e-06, 3.520999999999999e-06, 3.560999999999999e-06, 3.641000000000000e-06, 3.801000000000000e-06, 3.979597211851009e-06, 4.179597211851009e-06, 4.379597211851009e-06, 4.579597211851008e-06, 4.779597211851008e-06, 4.979597211851008e-06, 5.179597211851008e-06, 5.379597211851008e-06, 5.579597211851007e-06, 5.779597211851007e-06, 5.979597211851007e-06, 6.179597211851007e-06, 6.379597211851006e-06, 6.579597211851006e-06, 6.779597211851006e-06, 6.979597211851006e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000700000000000e-06, 7.001000000000000e-06, 7.001079999999999e-06, 7.001239999999999e-06, 7.001559999999999e-06, 7.002199999999999e-06, 7.003479999999999e-06, 7.006039999999998e-06, 7.011159999999996e-06, 7.021399999999993e-06, 7.041879999999985e-06, 7.082839999999971e-06, 7.164759999999943e-06, 7.306401532289403e-06, 7.318478064788666e-06, 7.342631129787190e-06, 7.348669396036821e-06, 7.360745928536084e-06, 7.384898993534609e-06, 7.433205123531657e-06, 7.505409418762610e-06, 7.622219576778190e-06, 7.742999908167346e-06, 7.942999908167346e-06, 8.142999908167346e-06, 8.342999908167345e-06, 8.542999908167345e-06, 8.742999908167345e-06, 8.942999908167345e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.300999999999998e-06, 9.500999999999998e-06, 9.520999999999997e-06, 9.560999999999997e-06, 9.640999999999996e-06, 9.800999999999996e-06, 9.978974581437602e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                4.999999919200253e+00, 4.999999919200255e+00, 4.999999919200257e+00, 4.999999919200257e+00, 4.999999919200254e+00, 4.999999919200251e+00, 4.999999919200262e+00, 4.999999919200238e+00, 4.999999919200220e+00, 4.999999919200224e+00, 4.999999919200335e+00, 4.999999919200595e+00, 4.999999919201074e+00, 4.999999919202737e+00, 4.999999919203373e+00, 4.999999919202466e+00, 4.999999919207248e+00, 4.999999919222666e+00, 4.999999919232952e+00, 4.999999919232896e+00, 4.999999919235138e+00, 5.000124013676115e+00, 5.000449644809906e+00, 5.001329565318438e+00, 5.002151320354394e+00, 5.002257931176161e+00, 5.002438731291836e+00, 5.002759875531355e+00, 5.003418829389991e+00, 5.004723690521532e+00, 5.007338182277549e+00, 5.012537599355243e+00, 5.022833864367484e+00, 5.042977321100457e+00, 5.081660972930782e+00, 5.152805430785034e+00, 5.271930426977085e+00, 5.255969233790093e+00, 1.875650939569375e+00, 1.655355969898117e-02, 9.556001645042004e-03, 8.136865215011708e-03, 7.985073458079497e-03, 7.760697026044105e-03, 7.884292942568174e-03, 7.763762091848382e-03, 7.859907320935727e-03, 7.720277896160717e-03, 7.464282606678842e-03, 7.089168014480994e-03, 6.639501735707142e-03, 6.021765651313742e-03, 6.343367833551087e-03, 7.492840043739433e-03, 1.052252760058226e-02, 2.183237193525422e-02, 5.187427607511873e-02, 1.338910818080578e-01, 2.753801394927131e-01, 4.713404644673220e-01, 7.099545099881287e-01, 9.802100003954627e-01, 1.271747888325117e+00, 1.574996394733722e+00, 1.881296854823639e+00, 2.183106622462620e+00, 2.474132828487931e+00, 2.749485735372362e+00, 3.005687963303573e+00, 3.240642817300832e+00, 3.453443602155948e+00, 3.644179422326411e+00, 3.662379728630661e+00, 3.662585299879685e+00, 3.663067665174840e+00, 3.664213504222711e+00, 3.665186048081400e+00, 3.665384419629818e+00, 3.665735315883072e+00, 3.666393122465745e+00, 3.667732679629078e+00, 3.670388991781171e+00, 3.675704186208955e+00, 3.686259923316456e+00, 3.707143038698101e+00, 3.747805332266094e+00, 3.816658429812950e+00, 3.571192303781204e+00, 1.137858494360595e+00, 9.014974815925411e-01, 5.114305820488912e-01, 4.317898940451413e-01, 2.895774711694458e-01, 7.882069192196429e-02, 1.607326694465361e-02, 1.218034787825219e-02, 8.940366671765431e-03, 8.465585229265897e-03, 7.810871038135640e-03, 7.933615066752445e-03, 7.741381854576213e-03, 7.888625655433749e-03, 7.757790710421915e-03, 7.870810757550325e-03, 7.786220710230148e-03, 7.700705127091174e-03, 7.472902842620830e-03, 7.081273182694703e-03, 6.648604047247847e-03, 6.001304047293490e-03, 6.333870834796702e-03, 7.494760135351435e-03, 1.052175678400317e-02, 2.183507140759269e-02, 5.169211273504988e-02, 5.736720851978777e-02
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 PULSE(0 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 5",
                "R1 vdd out 10k",
                "R2 in b 1k",
                "Q1 out b 0 0 mjd44h11",
                ".SAVE v(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }
    }
}
