using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SpiceSharp.Simulations;
using SpiceSharp.Components;

namespace SpiceSharpTest.Models.Bipolar
{
    /// <summary>
    /// BJT MJD44H11 (ON Semiconductors)
    /// </summary>
    [TestClass]
    public class SpiceSharpBipolarTest : Framework
    {
        /*
        [TestMethod]
        public void TestBJT_DC()
        {
            // Provided by Spice 3f5
            double[] reference = new double[]
            {
                -6.097599869520956e-37, -7.656097977815080e-13, -1.374900193695794e-12, -2.039257651631488e-12, -2.742694960033987e-12, -3.524291969370097e-12, -4.320099833421409e-12, -5.186961971048731e-12, -6.096456672821660e-12, -7.077005648170598e-12, -8.100187187665142e-12, 8.841977827306400e-12, -2.163602630389505e-12, -2.838618229361600e-12, -3.559819106158102e-12, -4.341416115494212e-12, -5.172751116333529e-12, -6.053824108676054e-12, -6.977529665164184e-12, -7.958078640513122e-12, -8.981260180007666e-12, -1.003286342893261e-11, 4.376458554330768e-10, -1.342783662039437e-10, -1.413802408478659e-10, -1.485318534832913e-10, -1.557296513965412e-10, -1.629842927286518e-10, -1.702744611975504e-10, -1.776072622305946e-10, -1.849969066824997e-10, -1.924576054079807e-10, -1.999467258428922e-10, 2.168331802615873e-08, -1.248734982084443e-08, -1.310184316594132e-08, -1.371638091995919e-08, -1.433097907010961e-08, -1.494561274739681e-08, -1.556030326810287e-08, -1.617502221051836e-08, -1.678982641806215e-08, -1.740465904731536e-08, -1.801953430913272e-08, 1.118392232919437e-06, -1.167279563674128e-06, -1.225296003326548e-06, -1.283312485611532e-06, -1.341329031845362e-06, -1.399345634922611e-06, -1.457362245105287e-06, -1.515378954763946e-06, -1.573395692844315e-06, -1.631412473557248e-06, -1.689429325324454e-06, 6.188771226659289e-05, -1.090991015075815e-04, -1.145814656631217e-04, -1.200638293852307e-04, -1.255461928977297e-04, -1.310285561686442e-04, -1.365109192050795e-04, -1.419932820567738e-04, -1.474756446668835e-04, -1.529580070638303e-04, -1.584403691765601e-04, 3.275398651073885e-03, -1.012844747663877e-02, -1.064307370146267e-02, -1.115769751705642e-02, -1.167231893956000e-02, -1.218693796899117e-02, -1.270155460535705e-02, -1.321616884872867e-02, -1.373078069903499e-02, -1.424539015641813e-02, -1.475999722086385e-02, 4.151238565042040e-02, -6.251622455931329e-01, -6.571964167557454e-01, -6.892240016470339e-01, -7.212450230668637e-01, -7.532594837398392e-01, -7.852673863879005e-01, -8.172687337325613e-01, -8.492635284927701e-01, -8.812517733859551e-01, -9.132334711280237e-01, 9.947058738595213e-02, -4.309497632319092e+00, -4.531107647603950e+00, -4.752561385490615e+00, -4.973908096406554e+00, -5.195147864142122e+00, -5.416280772366491e+00, -5.637306904689041e+00, -5.858226344618870e+00, -6.079039175577975e+00, -6.299745480900796e+00
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 b 0 0",
                "V2 c 0 0",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE I(V2)",
                ".DC V2 0 5 0.5 V1 0 0.8 0.1"
                );

            TestDC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_AC()
        {
            // Provided by Spice 3f5
            double[] reference = new double[]
            {
                1.334417655221981e-06, 3.471965089573855e-04, 3.351830745696013e-06, 5.502570946227631e-04, 8.418945895773095e-06, 8.720498043349111e-04, 2.114445669597715e-05, 1.381911086546095e-03, 5.309368526798768e-05, 2.189406695272188e-03, 1.332469066652801e-04, 3.466895147088519e-03, 3.339563613753496e-04, 5.482432501910041e-03, 8.341980040370838e-04, 8.640775529878610e-03, 2.066558898597437e-03, 1.350614394562201e-02, 5.017427448376650e-03, 2.069020111657962e-02, 1.162687214173939e-02, 3.025147596713823e-02, 2.444806066150139e-02, 4.013545957396424e-02, 4.357949902126839e-02, 4.514050832244691e-02, 6.329927287469508e-02, 4.136984589249247e-02, 7.720778968190564e-02, 3.183821694967992e-02, 8.460892410281305e-02, 2.201455496720340e-02, 8.796592758796802e-02, 1.444187547976473e-02, 8.937770311337523e-02, 9.259273400620089e-03, 8.995244044657570e-02, 5.881087349156842e-03, 9.018332766108905e-02, 3.722325696488050e-03, 9.027562051537531e-02, 2.354340724190566e-03, 9.031252808298670e-02, 1.491338054090604e-03, 9.032751174287083e-02, 9.494226860852369e-04, 9.033418279536445e-02, 6.121839678644588e-04, 9.033858322545092e-02, 4.068213923146900e-04, 9.034456220674270e-02, 2.884413123461178e-04, 9.035667499179965e-02, 2.293512095670885e-04, 9.038149464070865e-02, 2.102372862964381e-04, 9.042443030168182e-02, 2.125125991591739e-04, 9.048191631184549e-02, 2.196186992196002e-04, 9.054643271040638e-02, 2.275933681030558e-04, 9.062185343008869e-02, 2.359674744810228e-04, 9.071079692976204e-02, 2.293406880105455e-04, 9.079365040405127e-02, 1.944976240778528e-04, 9.084916360239491e-02, 1.441205567769769e-04, 9.087793546139709e-02, 9.797275248012720e-05, 9.089082649598122e-02, 6.381079386729101e-05, 9.089621923422748e-02, 4.078876004594734e-05, 9.089840984364973e-02, 2.587116901301420e-05, 9.089928903096885e-02, 1.635803306436918e-05, 9.089964017582838e-02, 1.033019503722961e-05, 9.089978014956063e-02, 6.520640901850731e-06, 9.089983590285976e-02, 4.115679165634339e-06, 9.089985810348898e-02, 2.598362267948606e-06, 9.089986694319310e-02, 1.641720674824373e-06, 9.089987046435224e-02, 1.039399501946855e-06
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 DC 0 AC 1 0",
                "Vsupply vdd 0 5",
                "R1 vdd out 1k",
                "R2 out b 10k",
                "Cin in b 1u",
                "Q1 c b 0 0 mjd44h11",
                ".SAVE vr(out) vi(out)",
                ".AC dec 5 10 10g"
                );

            TestAC(netlist, reference);
        }

        [TestMethod]
        public void TestBJT_Transient()
        {
            // Provided by Spice 3f5
            double[] reft = new double[]
            {
                0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11, 8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10, 1.280000000000000e-09, 2.560000000000000e-09, 5.120000000000001e-09, 1.024000000000000e-08, 2.048000000000000e-08, 4.096000000000000e-08, 8.192000000000001e-08, 1.638400000000000e-07, 3.276800000000000e-07, 5.276800000000000e-07, 7.276800000000000e-07, 9.276800000000000e-07, 1.000000000000000e-06, 1.000100000000000e-06, 1.000300000000000e-06, 1.000700000000000e-06, 1.001000000000000e-06, 1.001049696459596e-06, 1.001149089378787e-06, 1.001347875217170e-06, 1.001745446893937e-06, 1.002540590247469e-06, 1.004130876954533e-06, 1.007311450368662e-06, 1.013672597196919e-06, 1.026394890853435e-06, 1.051839478166465e-06, 1.102728652792526e-06, 1.204507002044648e-06, 1.404507002044648e-06, 1.604507002044648e-06, 1.795021509131585e-06, 1.948987782233362e-06, 2.108098212473162e-06, 2.308098212473162e-06, 2.508098212473162e-06, 2.708098212473161e-06, 2.908098212473161e-06, 3.001000000000000e-06, 3.021000000000000e-06, 3.061000000000000e-06, 3.141000000000000e-06, 3.301000000000000e-06, 3.501000000000000e-06, 3.520999999999999e-06, 3.560999999999999e-06, 3.641000000000000e-06, 3.801000000000000e-06, 3.979595922338221e-06, 4.179595922338221e-06, 4.379595922338221e-06, 4.579595922338221e-06, 4.779595922338220e-06, 4.979595922338220e-06, 5.179595922338220e-06, 5.379595922338220e-06, 5.579595922338220e-06, 5.779595922338219e-06, 5.979595922338219e-06, 6.179595922338219e-06, 6.379595922338219e-06, 6.579595922338218e-06, 6.779595922338218e-06, 6.979595922338218e-06, 7.000000000000000e-06, 7.000100000000000e-06, 7.000300000000000e-06, 7.000700000000000e-06, 7.001000000000000e-06, 7.001079999999999e-06, 7.001239999999999e-06, 7.001559999999999e-06, 7.002199999999999e-06, 7.003479999999999e-06, 7.006039999999998e-06, 7.011159999999996e-06, 7.021399999999993e-06, 7.041879999999985e-06, 7.082839999999971e-06, 7.164759999999943e-06, 7.306390803451833e-06, 7.318468698900779e-06, 7.342624489798672e-06, 7.348663437523145e-06, 7.360741332972092e-06, 7.384897123869984e-06, 7.433208705665770e-06, 7.505414609501787e-06, 7.622232720197830e-06, 7.743020365228342e-06, 7.943020365228342e-06, 8.143020365228341e-06, 8.343020365228341e-06, 8.543020365228341e-06, 8.743020365228341e-06, 8.943020365228340e-06, 9.000999999999999e-06, 9.020999999999999e-06, 9.060999999999998e-06, 9.140999999999998e-06, 9.300999999999998e-06, 9.500999999999998e-06, 9.520999999999997e-06, 9.560999999999997e-06, 9.640999999999996e-06, 9.800999999999996e-06, 9.978973520830014e-06, 9.999999999999999e-06
            };
            double[] refv = new double[]
            {
                4.999999919200253e+00, 4.999999919200253e+00, 4.999999919200256e+00, 4.999999919200265e+00, 4.999999919200269e+00, 4.999999919200270e+00, 4.999999919200274e+00, 4.999999919200310e+00, 4.999999919200295e+00, 4.999999919200242e+00, 4.999999919200256e+00, 4.999999919200442e+00, 4.999999919200887e+00, 4.999999919202219e+00, 4.999999919203312e+00, 4.999999919203345e+00, 4.999999919206253e+00, 4.999999919222164e+00, 4.999999919212636e+00, 4.999999919216738e+00, 4.999999919222017e+00, 5.000124015022816e+00, 5.000449651951924e+00, 5.001329576247615e+00, 5.002151293341414e+00, 5.002257929417378e+00, 5.002438724039524e+00, 5.002759846404913e+00, 5.003418712876405e+00, 5.004723224530464e+00, 5.007336318800409e+00, 5.012530149220850e+00, 5.022833882134534e+00, 5.042977334556558e+00, 5.081660920713526e+00, 5.152804197265928e+00, 5.271902529014626e+00, 5.255961725511093e+00, 1.875617294698409e+00, 1.655361247606981e-02, 9.556306793041053e-03, 8.143095659325651e-03, 7.985097494789570e-03, 7.763414179333034e-03, 7.883787330306542e-03, 7.763690924611548e-03, 7.859821345931772e-03, 7.719451331631350e-03, 7.459392533437188e-03, 7.089071427095065e-03, 6.635610778872991e-03, 6.022467496745492e-03, 6.343863966130725e-03, 7.492855234706399e-03, 1.052275592393182e-02, 2.183241153816638e-02, 5.191584805748978e-02, 1.338907237316577e-01, 2.754693238928807e-01, 4.714359645347004e-01, 7.100201039096334e-01, 9.802510338232866e-01, 1.271772571759655e+00, 1.575010844052070e+00, 1.881305068174714e+00, 2.183111109781683e+00, 2.474135133404021e+00, 2.749486790768636e+00, 3.005688322429076e+00, 3.240642802699120e+00, 3.453443398605113e+00, 3.644179134223966e+00, 3.662399421927875e+00, 3.662585980380271e+00, 3.663068357316088e+00, 3.664214225053304e+00, 3.665186716351549e+00, 3.665385093496764e+00, 3.665735976785826e+00, 3.666393731870234e+00, 3.667733083761534e+00, 3.670388572950689e+00, 3.675700454677043e+00, 3.686242649710791e+00, 3.707066783973132e+00, 3.747384438419909e+00, 3.816652716661827e+00, 3.570754348234623e+00, 1.137869825844853e+00, 9.015485310391745e-01, 5.114374218051296e-01, 4.317883404067391e-01, 2.896439882102821e-01, 7.880030660984598e-02, 1.607176535743225e-02, 1.218672633846727e-02, 8.940034780949789e-03, 8.466396310908189e-03, 7.810926065821902e-03, 7.931482402276063e-03, 7.741615150852236e-03, 7.888344042805985e-03, 7.757571072370122e-03, 7.870701571456922e-03, 7.786125081560294e-03, 7.700257099983869e-03, 7.468686766496058e-03, 7.081173512162859e-03, 6.644980558710726e-03, 6.001915555808019e-03, 6.334377328642827e-03, 7.494774724254995e-03, 1.052198511477223e-02, 2.183511028512625e-02, 5.173267278225494e-02, 5.736729685240333e-02
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 0 KF = 0 AF = 1",
                "V1 in 0 PULSE(0 5 1u 1n 0.5u 2u 6u)",
                "Vsupply vdd 0 5",
                "R1 vdd out 10k",
                "R2 in b 1k",
                "Q1 out b 0 0 mjd44h11",
                ".SAVE v(out)",
                ".tran 1n 10u"
            );

            TestTransient(netlist, reft, refv);
        }

        [TestMethod]
        public void TestBJT_Noise()
        {
            // Provided by Spice 3f5
            double[] reference_in = new double[]
            {
                9.782223714427987e-05, 4.902727264832426e-05, 2.457185338962746e-05, 1.231510568597593e-05, 6.172177827238539e-06, 3.093419303221456e-06, 1.550383886524483e-06, 7.770336358384338e-07, 3.894399852531180e-07, 1.951827573570842e-07, 9.782336428330867e-08, 4.902798449718650e-08, 2.457230320810896e-08, 1.231539017446422e-08, 6.172357999553372e-09, 3.093533656480485e-09, 1.550456710766847e-09, 7.770802570427241e-10, 3.894700734580881e-10, 1.952024139447066e-10, 9.783643896535056e-11, 4.903690627756174e-11, 2.457860468467670e-11, 1.232003835109984e-11, 6.175963014454194e-12, 3.096480480823246e-12, 1.552988244942930e-12, 7.793497608380497e-13, 3.915742472601946e-13, 1.972022715733277e-13, 9.977047753816183e-14, 5.092941583370216e-14, 2.644491120273891e-14, 1.416981186983834e-14, 8.015304915842651e-15, 4.929240476629539e-15, 3.381595339081205e-15, 2.605336551167759e-15, 2.215907737656946e-15, 2.020492600234610e-15, 1.922402615640859e-15, 1.873146263769304e-15, 1.848399728757252e-15, 1.835959299430869e-15, 1.829700476303181e-15, 1.826548592807994e-15, 1.824959418653644e-15, 1.824156956827553e-15, 1.823750995014642e-15, 1.823545148259813e-15, 1.823440476369602e-15, 1.823387067116046e-15, 1.823359700277232e-15, 1.823345606548012e-15, 1.823338304563228e-15, 1.823334494489318e-15, 1.823332490025238e-15, 1.823331425533426e-15, 1.823330854242250e-15, 1.823330544080329e-15, 1.823330373590984e-15, 1.823330278655256e-15, 1.823330225089411e-15, 1.823330194469076e-15, 1.823330176745610e-15, 1.823330166369695e-15, 1.823330160237792e-15, 1.823330156593352e-15, 1.823330154432723e-15, 1.823330153180771e-15, 1.823330152512752e-15, 1.823330152257153e-15, 1.823330152345095e-15, 1.823330152788673e-15, 1.823330153680120e-15, 1.823330155209951e-15, 1.823330157707057e-15, 1.823330161708856e-15, 1.823330168076021e-15, 1.823330178175495e-15, 1.823330194168774e-15, 1.823330219461373e-15, 1.823330259394320e-15, 1.823330322284795e-15, 1.823330420928892e-15, 1.823330574589480e-15, 1.823330811070094e-15, 1.823331167039915e-15, 1.823331680639254e-15, 1.823332361170861e-15, 1.823333113314647e-15
            };
            double[] reference_out = new double[]
            {
                1.179219862989481e-11, 9.366799509824981e-12, 7.440215819393452e-12, 5.909849953969606e-12, 4.694204355116928e-12, 3.728541470609732e-12, 2.961436248069141e-12, 2.352037572092826e-12, 1.867892810716822e-12, 1.483219628924207e-12, 1.177533053932103e-12, 9.345547120412678e-13, 7.413462160103590e-13, 5.876206817161517e-13, 4.651959586434446e-13, 3.675609264002581e-13, 2.895326170890468e-13, 2.269873731311376e-13, 1.766539773722950e-13, 1.359604399125598e-13, 1.029274183594503e-13, 7.609663023305161e-14, 5.446842860703937e-14, 3.740481097004802e-14, 2.446189680290874e-14, 1.518227588269855e-14, 8.959195761725242e-15, 5.059913505431299e-15, 2.760736675274261e-15, 1.470044930464820e-15, 7.716487852712253e-16, 4.034529515752228e-16, 2.127468258361768e-16, 1.151235562432188e-16, 6.553027189419247e-17, 4.046020619340668e-17, 2.782674437697462e-17, 2.147313449302714e-17, 1.828183346826315e-17, 1.668018849406525e-17, 1.587676549007375e-17, 1.547387872517497e-17, 1.527188688617226e-17, 1.517062892416029e-17, 1.511987266797110e-17, 1.509443203139195e-17, 1.508168078745598e-17, 1.507528979199142e-17, 1.507208662826275e-17, 1.507048121609172e-17, 1.506967659369265e-17, 1.506927332291652e-17, 1.506907120673515e-17, 1.506896990763351e-17, 1.506891913722307e-17, 1.506889369138883e-17, 1.506888093804600e-17, 1.506887454609958e-17, 1.506887134245389e-17, 1.506886973677496e-17, 1.506886893199605e-17, 1.506886852863024e-17, 1.506886832645527e-17, 1.506886822511944e-17, 1.506886817432599e-17, 1.506886814886564e-17, 1.506886813610314e-17, 1.506886812970543e-17, 1.506886812649814e-17, 1.506886812489016e-17, 1.506886812408394e-17, 1.506886812367966e-17, 1.506886812347690e-17, 1.506886812337520e-17, 1.506886812332418e-17, 1.506886812329857e-17, 1.506886812328572e-17, 1.506886812327926e-17, 1.506886812327602e-17, 1.506886812327438e-17, 1.506886812327356e-17, 1.506886812327315e-17, 1.506886812327294e-17, 1.506886812327284e-17, 1.506886812327278e-17, 1.506886812327275e-17, 1.506886812327274e-17, 1.506886812327273e-17, 1.506886812327273e-17, 1.506886812327273e-17, 1.506886812327273e-17
            };

            var netlist = Run(
                ".MODEL mjd44h11 npn",
                "+ IS = 1.45468e-14 BF = 135.617 NF = 0.85 VAF = 10",
                "+ IKF = 5.15565 ISE = 2.02483e-13 NE = 3.99964 BR = 13.5617",
                "+ NR = 0.847424 VAR = 100 IKR = 8.44427 ISC = 1.86663e-13",
                "+ NC = 1.00046 RB = 1.35729 IRB = 0.1 RBM = 0.1",
                "+ RE = 0.0001 RC = 0.037687 XTB = 0.90331 XTI = 1",
                "+ EG = 1.20459 CJE = 3.02297e-09 VJE = 0.649408 MJE = 0.351062",
                "+ TF = 2.93022e-09 XTF = 1.5 VTF = 1.00001 ITF = 0.999997",
                "+ CJC = 3.0004e-10 VJC = 0.600008 MJC = 0.409966 XCJC = 0.8",
                "+ FC = 0.533878 CJS = 0 VJS = 0.75 MJS = 0.5",
                "+ TR = 2.73328e-08 PTF = 1 KF = 1e-8 AF = 1",
                "V1 in 0 DC 0 AC 1 0",
                "Vsupply vdd 0 5",
                "R1 vdd out 1k",
                "R2 out b 10k",
                "Cin in b 1u",
                "Q1 c b 0 0 mjd44h11",
                ".NOISE v(out) V1 dec 10 10 10g");
            TestNoise(netlist, reference_in, reference_out);
        }
        */
    }
}
